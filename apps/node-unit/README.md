# Node Unit

主 / 从节点模式:

根据环境变量 `HOST_URL` 的配置情况，节点可以运行在两种模式之一:

- 主节点模式: 创建主机，供从节点(和其他各种终端)连接，提供 HTTP / WS / HTTPS / WSS 服务。必须不配置 `HOST_URL`。
- 从节点模式: 连接主节点，提供附加的计算资源支持。必须配置 `HOST_URL`。

主 / 从节点模式都支持的环境变量:

| 变量名                 | 说明                                                                                          | 默认值                                            |
| ---------------------- | --------------------------------------------------------------------------------------------- | ------------------------------------------------- |
| NODE_UNIT_NAME         | 节点的名字 (任意字符串)，用于身份标识和加密通信，可以明文传输                                 | `os.hostname()`                                   |
| NODE_UNIT_PASSWORD     | 节点的密码 (任意字符串)，用于身份标识和加密通信，需要妥善保存                                 | `randomUUID()`                                    |
| POSTGRES_URI           | PostgreSQL 连接字符串，如果非空将创建本地的 PG 连接服务                                       | `''`                                              |
| TRUSTED_PACKAGE_REGEXP | 信任的包名正则表达式，允许从节点运行这些包的代码，正则表达式会检验字符串 `${name}@${version}` | `'^@yuants/'` (信任 @yuants 下的所有包的所有版本) |
| ENABLE_CUSTOM_COMMAND  | 是否启用自定义命令功能，如果启用，将允许自定义命令 (建议仅在容器沙盒的安全环境使用)           | `'false'`                                         |
| PG_PACKAGE_VERSION     | `@yuants/app-postgres-storage` 的版本号，仅对 POSTGRES_URI 的本地 PG 连接服务有效             | `'latest'`                                        |

主节点环境专用变量表:

| 变量名               | 说明                                                    | 默认值     |
| -------------------- | ------------------------------------------------------- | ---------- |
| HOST_TOKEN           | 主节点模式下，设置认证令牌                              | `''`       |
| PORT                 | 主节点模式的 HTTP / WS 监听端口                         | `'8888'`   |
| SSL_PORT             | 主节点模式的 HTTPS / WSS 监听端口                       | `'18888'`  |
| SSL_KEY_PATH         | 主节点模式的 HTTPS / WSS 私钥文件路径，留空时不启动 TLS | `''`       |
| SSL_CERT_PATH        | 主节点模式的 HTTPS / WSS 证书文件路径，留空时不启动 TLS | `''`       |
| HOST_PACKAGE_VERSION | `@yuants/app-host` 的版本号                             | `'latest'` |

从节点环境专用变量表:

| 变量名   | 说明                         | 默认值 |
| -------- | ---------------------------- | ------ |
| HOST_URL | 从节点模式，连接主节点的地址 | 必填   |

## Kubernetes DaemonSet

在 k8s 集群中，Node Unit 将以 DaemonSet 的形式运行在每个节点上，提供计算资源支持。

Node Unit 会根据 k8s 节点的名字作为种子，生成唯一的 ED25519 私钥，从而保证每个节点的身份唯一且稳定。

但是请注意，当 k8s 节点被删除并重新创建时，节点名字可能会变化，从而导致生成的私钥变化，进而导致节点身份变化。

节点身份的变化，可能会导致某些部署在该节点上的服务无法识别新的节点身份，从而影响服务的正常运行。
