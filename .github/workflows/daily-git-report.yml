name: Daily Git Change Report

on:
  schedule:
    # ä¸œå…«åŒºæ—©ä¸Š8ç‚¹è¿è¡Œ (UTC 0ç‚¹)
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      timezone_offset:
        description: 'æ—¶åŒºåç§»å°æ—¶æ•° (ä¾‹å¦‚ +8 è¡¨ç¤ºä¸œå…«åŒº)'
        required: false
        default: '+8'
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  generate-report:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.14.0'

      - name: Prepare report date
        id: report_date
        run: echo "value=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT

      - name: Get daily commit range
        id: commit_range
        run: |
          chmod +x .claude/skills/git-changes-reporter/scripts/get-daily-commit-range.sh
          .claude/skills/git-changes-reporter/scripts/get-daily-commit-range.sh ${{ github.event.inputs.timezone_offset || '+8' }}

      - name: Display commit range
        run: |
          echo "æäº¤èŒƒå›´: ${{ steps.commit_range.outputs.old_commit_short }}..${{ steps.commit_range.outputs.new_commit_short }}"
          echo "æäº¤æ•°é‡: ${{ steps.commit_range.outputs.commit_count }}"

      - name: Generate JSON data
        id: generate_json
        run: |
          REPORT_DATE=${{ steps.report_date.outputs.value }}
          mkdir -p docs/reports
          node .claude/skills/git-changes-reporter/scripts/generate-json.js \
            "${{ steps.commit_range.outputs.old_commit }}" \
            "${{ steps.commit_range.outputs.new_commit }}" \
            "docs/reports/git-changes-${REPORT_DATE}.json"
          echo "json_file=docs/reports/git-changes-${REPORT_DATE}.json" >> $GITHUB_OUTPUT

      - name: Generate report with Claude Code
        id: generate_report
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            è¯·ä½¿ç”¨ git-changes-reporter skill ç”Ÿæˆ Git å˜æ›´æŠ¥å‘Šã€‚

            ä»»åŠ¡ä¿¡æ¯ï¼š
            - èµ·å§‹æäº¤: ${{ steps.commit_range.outputs.old_commit }}
            - ç»“æŸæäº¤: ${{ steps.commit_range.outputs.new_commit }}
            - æäº¤èŒƒå›´: ${{ steps.commit_range.outputs.old_commit_short }}..${{ steps.commit_range.outputs.new_commit_short }}
            - æäº¤æ•°é‡: ${{ steps.commit_range.outputs.commit_count }}
            - è¾“å‡ºæ–‡ä»¶: docs/reports/git-changes-report-$(date +%Y-%m-%d).md

            è¯·ä¸¥æ ¼æŒ‰ç…§ git-changes-reporter skill çš„æ‰€æœ‰è§„åˆ™ç”ŸæˆæŠ¥å‘Šï¼Œç‰¹åˆ«æ˜¯ï¼š
            1. å¿…é¡»ä½¿ç”¨çŸ­å“ˆå¸Œå¼•ç”¨æäº¤ï¼Œä¸è¦ä½¿ç”¨ JSON æ–‡ä»¶è¡Œå·
            2. æŒ‰æŠ€æœ¯é¢†åŸŸè¿›è¡Œè¯­ä¹‰èšç±»
            3. åŒ…å«å®Œæ•´çš„æŠ¥å‘Šç»“æž„
            4. æä¾›å…·ä½“çš„æ–‡ä»¶å¼•ç”¨å’Œä»£ç ä½ç½®

            è¯·å…ˆç”Ÿæˆ JSON æ•°æ®ï¼Œç„¶åŽåŸºäºŽ JSON æ•°æ®ç”Ÿæˆè¯­ä¹‰åŒ–æŠ¥å‘Šã€‚
        env:
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: 'https://api.deepseek.com/anthropic'
          ANTHROPIC_MODEL: 'deepseek-reasoner'
          ANTHROPIC_SMALL_FAST_MODEL: 'deepseek-chat'
          API_TIMEOUT_MS: '600000'
          CLAUDE_CODE_MAX_OUTPUT_TOKENS: '32000'
          CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC: '1'

      - name: Check if report was generated
        id: check_report
        run: |
          MD_FILE="docs/reports/git-changes-report-${{ steps.report_date.outputs.value }}.md"
          if [ -f "$MD_FILE" ]; then
            echo "æŠ¥å‘Šæ–‡ä»¶å·²ç”Ÿæˆ: $MD_FILE"
            echo "report_generated=true" >> $GITHUB_OUTPUT
          else
            echo "æŠ¥å‘Šæ–‡ä»¶æœªç”Ÿæˆ: $MD_FILE"
            echo "report_generated=false" >> $GITHUB_OUTPUT
          fi

      - name: Create or update PR
        id: create_pr
        if: steps.check_report.outputs.report_generated == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          REPORT_DATE=${{ steps.report_date.outputs.value }}
          BRANCH_NAME="daily-report-${REPORT_DATE}"
          git checkout -B "$BRANCH_NAME"
          git add docs/reports/

          if git diff --cached --quiet; then
            echo "æ²¡æœ‰å˜æ›´ï¼Œè·³è¿‡ PR åˆ›å»º"
            echo "pr_created=false" >> $GITHUB_OUTPUT
          else
            git commit -m "feat: add daily git change report for ${REPORT_DATE} - ${{ steps.commit_range.outputs.commit_count }} commits"
            git push origin "$BRANCH_NAME" --force

            PR_TITLE="Daily Git Change Report ${REPORT_DATE}"
            PR_BODY=$(cat <<-EOF
            ## æ¯æ—¥ Git å˜æ›´æŠ¥å‘Š

            ### æŠ¥å‘Šä¿¡æ¯
            - **æ—¥æœŸ**: ${REPORT_DATE}
            - **æäº¤èŒƒå›´**: ${{ steps.commit_range.outputs.old_commit_short }}..${{ steps.commit_range.outputs.new_commit_short }}
            - **æäº¤æ•°é‡**: ${{ steps.commit_range.outputs.commit_count }}
            - **ç”Ÿæˆæ—¶é—´**: $(date -Iseconds)

            ### åŒ…å«æ–‡ä»¶
            1. \`docs/reports/git-changes-${REPORT_DATE}.json\` - ç»“æž„åŒ– JSON æ•°æ®
            2. \`docs/reports/git-changes-report-${REPORT_DATE}.md\` - å®Œæ•´çš„è¯­ä¹‰åŒ–æŠ¥å‘Š

            ### æŠ¥å‘Šç‰¹ç‚¹
            - ä½¿ç”¨ Claude Code çš„ git-changes-reporter skill ç”Ÿæˆ
            - åŒ…å«æŠ€æœ¯é¢†åŸŸåˆ†æž
            - è´¡çŒ®è€…ç»Ÿè®¡å’Œåˆ†æž
            - é£Žé™©è¯„ä¼°å’Œå»ºè®®
            - å…·ä½“çš„æ–‡ä»¶å¼•ç”¨å’Œä»£ç ä½ç½®

            ### è‡ªåŠ¨åŒ–
            æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆï¼Œè®¡åˆ’æ¯å¤©ä¸œå…«åŒºæ—©ä¸Š8ç‚¹è¿è¡Œã€‚

            ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
            EOF
            )

            gh pr create \
              --title "$PR_TITLE" \
              --body "$PR_BODY" \
              --base main \
              --head "$BRANCH_NAME" \
              --label automated \
              --label report \
              --label daily || echo "PR åˆ›å»ºå¤±è´¥ï¼Œå¯èƒ½å·²å­˜åœ¨"

            echo "pr_created=true" >> $GITHUB_OUTPUT
            echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          fi

      - name: Upload reports as artifact
        if: steps.check_report.outputs.report_generated == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: daily-git-reports-${{ steps.report_date.outputs.value }}
          path: |
            docs/reports/git-changes-${{ steps.report_date.outputs.value }}.json
            docs/reports/git-changes-report-${{ steps.report_date.outputs.value }}.md
          retention-days: 7
