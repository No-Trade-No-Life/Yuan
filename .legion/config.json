{
  "version": "1.0.0",
  "currentTask": "ohlc-ohlc-v2",
  "settings": {
    "autoRemind": true,
    "remindBeforeReset": true,
    "taskCreationPolicy": "agent-with-approval"
  },
  "tasks": [
    {
      "id": "implement-quote-service",
      "name": "implement-quote-service",
      "status": "archived",
      "createdAt": "2025-12-14T14:34:05.766Z",
      "updatedAt": "2025-12-15T14:53:51.731Z"
    },
    {
      "id": "task-vex-quote-routing",
      "name": "task-vex-quote-routing",
      "status": "archived",
      "createdAt": "2025-12-15T08:09:34.654Z",
      "updatedAt": "2025-12-15T14:41:30.204Z"
    },
    {
      "id": "task-vex-quote-upstream-refactor",
      "name": "task-vex-quote-upstream-refactor",
      "status": "archived",
      "createdAt": "2025-12-16T15:02:37.063Z",
      "updatedAt": "2025-12-17T07:08:42.959Z"
    },
    {
      "id": "task-vex-queryquotes-swr",
      "name": "task-vex-queryquotes-swr",
      "status": "paused",
      "createdAt": "2025-12-17T08:48:48.898Z",
      "updatedAt": "2025-12-19T07:42:29.750Z"
    },
    {
      "id": "review-new-scheduler-design",
      "name": "review-new-scheduler-design",
      "status": "archived",
      "createdAt": "2025-12-19T07:42:29.750Z",
      "updatedAt": "2025-12-19T10:56:50.614Z"
    },
    {
      "id": "telegram",
      "name": "移除 Telegram 遗留代码（前后端）并清理重构命名",
      "status": "paused",
      "createdAt": "2025-12-19T13:01:53.394Z",
      "updatedAt": "2025-12-20T06:17:22.445Z"
    },
    {
      "id": "yuantsexchange-ohlcinterestrate",
      "name": "@yuants/exchange 增加 OHLC/InterestRate 历史数据写入服务",
      "status": "paused",
      "createdAt": "2025-12-19T13:45:29.155Z",
      "updatedAt": "2025-12-20T12:35:10.773Z"
    },
    {
      "id": "vendors-ingest-ohlc-interest-rate",
      "name": "vendors-ingest-ohlc-interest-rate",
      "status": "paused",
      "createdAt": "2025-12-20T06:17:22.445Z",
      "updatedAt": "2025-12-21T14:29:28.426Z"
    },
    {
      "id": "alert-receiver-resolverepeat",
      "name": "alert-receiver 修复 resolve/repeat 加急与去重",
      "status": "paused",
      "createdAt": "2025-12-21T14:29:28.426Z",
      "updatedAt": "2025-12-21T14:55:52.892Z"
    },
    {
      "id": "task-42a439ec",
      "name": "多账户切换：新增切换账户弹窗并保留本地凭据",
      "status": "paused",
      "createdAt": "2025-12-21T14:34:42.022Z",
      "updatedAt": "2025-12-22T07:09:48.363Z"
    },
    {
      "id": "vex-series-data-ohlcinterestrate-ohlc-v2",
      "name": "VEX series-data 调度器（OHLC/InterestRate）+ ohlc_v2 迁移",
      "status": "paused",
      "createdAt": "2025-12-22T07:09:48.363Z",
      "updatedAt": "2025-12-26T06:38:21.408Z"
    },
    {
      "id": "binance-private-api-host-tokenbucket",
      "name": "Binance private-api 按 host 选择 tokenBucket 并按权重限流",
      "status": "archived",
      "createdAt": "2025-12-24T13:32:36.757Z",
      "updatedAt": "2025-12-24T15:45:37.993Z"
    },
    {
      "id": "aster-publicprivate-api-host-tokenbucket",
      "name": "Aster public/private API 按 host 选择 tokenBucket 并主动限流",
      "status": "archived",
      "createdAt": "2025-12-24T15:32:00.428Z",
      "updatedAt": "2025-12-24T15:45:22.634Z"
    },
    {
      "id": "huobi-publicprivate-api-tokenbucket",
      "name": "Huobi public/private API tokenBucket：按业务与接口类型主动限流",
      "status": "paused",
      "createdAt": "2025-12-25T16:39:56.385Z",
      "updatedAt": "2025-12-26T04:49:50.074Z"
    },
    {
      "id": "hyperliquid-api-tokenbucket",
      "name": "Hyperliquid API tokenBucket：按官方限额主动限流",
      "status": "paused",
      "createdAt": "2025-12-26T06:38:21.408Z",
      "updatedAt": "2026-01-05T06:32:01.454Z"
    },
    {
      "id": "okx-ohlcpublishchannelohlc-ohlc-v2",
      "name": "OKX OHLC：publishChannel('ohlc') 梳理 + 写入 ohlc_v2 双写",
      "status": "paused",
      "createdAt": "2026-01-05T06:32:01.454Z",
      "updatedAt": "2026-01-05T07:44:14.014Z"
    },
    {
      "id": "rush-pnpm-tsheft-2026-01",
      "name": "全仓 Rush + PNPM + TS/Heft 工具链升级（2026-01）",
      "status": "paused",
      "createdAt": "2026-01-05T07:44:14.014Z",
      "updatedAt": "2026-01-07T08:31:34.455Z"
    },
    {
      "id": "ohlc-ohlc-v2",
      "name": "移除旧 ohlc 表引用并切换到 ohlc_v2",
      "status": "active",
      "createdAt": "2026-01-07T08:31:34.455Z",
      "updatedAt": "2026-01-07T09:35:13.640Z"
    }
  ],
  "pendingProposals": [
    {
      "id": "proposal-mj5ts62s-871f9c",
      "name": "implement-quote-service",
      "goal": "Implement quote service adapters for all vendors following provideQuoteService interface",
      "rationale": "Need to extend quote service support across all vendor adapters to align with @yuants/exchange provideQuoteService contract and keep vendor implementations consistent with vendor-gate example.",
      "points": [
        "Follow provideQuoteService from @yuants/exchange",
        "Use vendor-gate quote example as template",
        "Keep code simple and consistent with repository style",
        "Cover vendors: okx, binance, aster, hyperliquid, bitget, huobi"
      ],
      "scope": [
        "libs/exchange/src/services/quote.ts",
        "apps/vendor-gate/src/services/markets/quote.ts",
        "apps/vendor-okx",
        "apps/vendor-binance",
        "apps/vendor-aster",
        "apps/vendor-hyperliquid",
        "apps/vendor-bitget",
        "apps/vendor-huobi"
      ],
      "phases": [
        {
          "name": "Discovery",
          "tasks": [
            {
              "acceptance": "Interfaces and existing implementation references are identified and summarized",
              "description": "Review @yuants/exchange provideQuoteService and vendor-gate quote implementations to understand contract and usage patterns"
            }
          ]
        },
        {
          "name": "Design",
          "tasks": [
            {
              "acceptance": "Plan covering each target vendor (okx, binance, aster, hyperliquid, bitget, huobi) with mappings/input sources is documented",
              "description": "Outline approach to add quote services for each vendor and note required data sources and edge cases"
            }
          ]
        },
        {
          "name": "Implementation",
          "tasks": [
            {
              "acceptance": "Quote services added for all target vendors with tests/validation steps listed",
              "description": "Implement and wire quote service adapters for each vendor, aligning with existing patterns and verifying output format"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2025-12-14T14:33:48.485Z",
      "status": "approved",
      "decidedAt": "2025-12-14T14:34:05.766Z",
      "decidedBy": "Claude",
      "createdTaskId": "implement-quote-service"
    },
    {
      "id": "proposal-mj6vhup2-9ba350",
      "name": "task-vex-quote-routing",
      "goal": "Design quote routing in virtual-exchange quote service (compute per-upstream requests from cacheMissed + terminal metadata) and implement TODO accordingly.",
      "rationale": "User requested a new LegionMind task to track discovery/design for implementing the TODO in `apps/virtual-exchange/src/quote/service.ts` (quote routing based on cacheMissed and upstream metadata).",
      "points": [
        "Read existing upstream quote service implementation and metadata mapping patterns",
        "Determine how to locate quote service metadata from terminal service info (per @yuants/exchange quote.ts)",
        "Design routing algorithm: (cacheMissed, upstream metadata) -> requests per service",
        "Plan Promise.all execution and result aggregation",
        "Implement TODO after plan review"
      ],
      "scope": [
        "apps/virtual-exchange/src/quote/service.ts",
        "apps/virtual-exchange/src/quote/state.ts",
        "libraries/exchange/src/quote.ts"
      ],
      "phases": [
        {
          "name": "Discovery",
          "tasks": [
            {
              "description": "Inspect TODO in `apps/virtual-exchange/src/quote/service.ts` and surrounding flow.",
              "acceptance": "Clear list of required inputs/outputs and constraints for the TODO."
            },
            {
              "description": "Study `libraries/exchange/src/quote.ts` for how quote service metadata is derived from terminal service info.",
              "acceptance": "Documented mapping rules: where metadata lives, key names, and how to identify quote service."
            },
            {
              "description": "Review existing Legion task `.legion/tasks/implement-quote-service` for upstream quote service implementation patterns.",
              "acceptance": "Summary of the upstream request/response wiring and any caching/routing patterns."
            }
          ]
        },
        {
          "name": "Design",
          "tasks": [
            {
              "description": "Design routing: compute which upstream service(s) to call and what request payload each needs, from `(cacheMissed, upstream terminal metadata)`.",
              "acceptance": "Algorithm documented with inputs/outputs, edge cases, and data structures."
            },
            {
              "description": "Design concurrency and aggregation: `Promise.all` execution plan and how to merge results back into cache/state.",
              "acceptance": "Documented concurrency strategy, failure handling, and result merge semantics."
            }
          ]
        },
        {
          "name": "Implementation (after review)",
          "tasks": [
            {
              "description": "Implement the TODO in `apps/virtual-exchange/src/quote/service.ts` according to the approved design.",
              "acceptance": "TODO removed, code compiles, behavior matches design."
            },
            {
              "description": "Add or update any necessary types/tests/docs consistent with repo patterns.",
              "acceptance": "No lint/type/test regressions; docs updated if needed."
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2025-12-15T08:09:32.582Z",
      "status": "approved",
      "decidedAt": "2025-12-15T08:09:34.654Z",
      "decidedBy": "Claude",
      "createdTaskId": "task-vex-quote-routing"
    },
    {
      "id": "proposal-mj79oia3-b9f818",
      "name": "extract-fnv1a64hex-to-utils",
      "goal": "将 FNV-1a 64-bit hex 哈希实现抽到 `@yuants/utils`，并在 alert-receiver / virtual-exchange 复用。",
      "rationale": "`apps/alert-receiver` 与 `apps/virtual-exchange` 都各自实现了同一套 FNV-1a 64 hex（含 0xff 分隔）逻辑；抽到 `@yuants/utils` 可去重、降低后续维护成本，并便于其它模块（如 quote routing 的 request key）复用。",
      "points": [
        "在 `libraries/utils/src/fnv1a64Hex.ts` 暴露 `fnv1a64Hex(bytes)`",
        "为 util 增加最小单测（固定向量）",
        "`apps/alert-receiver` 的 alert fingerprint 改为复用 util",
        "`apps/virtual-exchange` 的 request-key 改为复用 util，删除重复实现",
        "跑 prettier + 最小构建/测试验证"
      ],
      "scope": [
        "libraries/utils/src/fnv1a64Hex.ts",
        "libraries/utils/src/fnv1a64Hex.test.ts",
        "libraries/utils/src/index.ts",
        "apps/alert-receiver/src/alertmanager-compatible-utils/fingerprint.ts",
        "apps/virtual-exchange/src/quote/request-key.ts"
      ],
      "phases": [
        {
          "name": "实现",
          "tasks": [
            {
              "description": "在 `@yuants/utils` 新增 `fnv1a64Hex(bytes)` 并导出。",
              "acceptance": "其它包可通过 `@yuants/utils` 导入并使用；实现返回 16 位小写 hex。"
            },
            {
              "description": "为 `fnv1a64Hex` 增加单测覆盖固定输入向量。",
              "acceptance": "测试断言通过：空串/hello/foobar 等已知向量匹配。"
            },
            {
              "description": "在 alert-receiver 复用 `fnv1a64Hex`，保持 `computeAlertFingerprint` 行为不变。",
              "acceptance": "现有 `fingerprint.test.ts` 通过且产出值不变。"
            },
            {
              "description": "在 virtual-exchange 复用 `fnv1a64Hex`，移除本地 32-bit 实现。",
              "acceptance": "`fnv1a64HexFromStrings` 输出与原实现一致（随机向量比对/或现有调用点不变）。"
            }
          ]
        },
        {
          "name": "格式化与验证",
          "tasks": [
            {
              "description": "运行 prettier，并执行最小构建/测试验证。",
              "acceptance": "格式无噪音；相关包 build/test 不回归。"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2025-12-15T14:46:37.707Z",
      "status": "pending"
    },
    {
      "id": "proposal-mj8poum9-556f39",
      "name": "task-vex-quote-upstream-refactor",
      "goal": "Refactor VEX quote upstream routing into layered modules (registry/router/executor) with clear interfaces, remove debug leftovers, and unify log tags.",
      "rationale": "用户明确要求对 upstream-routing 进行按概念/领域/切面分层的重构，并允许新建 Legion 任务来跟踪设计与实现；该重构涉及多文件拆分与接口设计，适合用 legionmind 持久化记录。",
      "points": [
        "遵循 `docs/zh-Hans/code-guidelines/exchange.md` 的 L1 报价路由算法（prefix 匹配 + field 倒排 + 交集）",
        "保持现有错误语义（provider not found / product unroutable / upstream error / freshness hard requirement）",
        "并发策略保持：同 provider group 串行（=1），全局并发上限 32，in-flight 去重",
        "纯函数尽量贴近对应 interface，返回值改为语义对象减少调用方解包",
        "目录组织保持简洁、贴合 quote 模块现有结构"
      ],
      "scope": [
        "apps/virtual-exchange/src/quote/upstream-routing.ts",
        "apps/virtual-exchange/src/quote/types.ts",
        "apps/virtual-exchange/src/quote/*(new: registry/router/executor modules)"
      ],
      "phases": [
        {
          "name": "Discovery",
          "tasks": [
            {
              "description": "阅读并梳理 `apps/virtual-exchange/src/quote/upstream-routing.ts` 当前的领域逻辑与切面逻辑耦合点，列出需要保留的不变量（L1 路由算法、freshness、in-flight、LB、并发限制、日志）。",
              "acceptance": "context.md 记录现状问题清单 + 不变量清单。"
            }
          ]
        },
        {
          "name": "Design",
          "tasks": [
            {
              "description": "定义分层接口（`IQuoteProviderRegistry` / `IQuoteRouter` / `IGetQuotesExecutor`）以及更易懂的返回值对象（例如 `QuoteUpstreamPlan`），并确定目录拆分方案。",
              "acceptance": "plan.md 给出接口草图、职责边界、文件列表与迁移步骤。"
            }
          ]
        },
        {
          "name": "Refactor",
          "tasks": [
            {
              "description": "移除临时调试残留（例如 `11111111`）并统一日志 tag 为 `[VEX][Quote]`。",
              "acceptance": "不再出现临时 debug 输出；日志 tag 统一。"
            },
            {
              "description": "将 provider discovery 逻辑抽到 registry 模块，实现 `snapshot()`；把路由/分批抽到 router；把 LB/并发/in-flight 抽到 executor；`fillQuoteStateFromUpstream` 只做编排。",
              "acceptance": "`upstream-routing.ts` 体积显著下降，职责清晰，调用点无语义变化。"
            }
          ]
        },
        {
          "name": "Validation",
          "tasks": [
            {
              "description": "运行 prettier + 最小编译检查（尽量只覆盖 apps/virtual-exchange 相关）。",
              "acceptance": "格式无噪音，TypeScript 编译通过（或给出可复现的失败原因）。"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2025-12-16T15:02:33.729Z",
      "status": "approved",
      "decidedAt": "2025-12-16T15:02:37.063Z",
      "decidedBy": "Claude",
      "createdTaskId": "task-vex-quote-upstream-refactor"
    },
    {
      "id": "proposal-mj9rk1aj-0b08f4",
      "name": "task-vex-queryquotes-swr",
      "goal": "将 `apps/virtual-exchange/src/quote/service.ts` 的 `VEX/QueryQuotes` 改为 SWR：请求立即返回本地缓存结果，后台串行补全缺失报价。",
      "rationale": "你要求 `VEX/QueryQuotes` 走 stale-while-revalidate：调用方大多轮询且更关心低延迟与最终收敛；同时我们需要避免在高频轮询下把上游 GetQuotes 打爆，因此用 RxJS 串行队列把“补全”从同步路径移到后台，并在执行时重新计算 miss 以自然去重。",
      "points": [
        "同步路径：总是 `computeCacheMissed`；若存在 miss 则立刻 `Subject.next(updateTask)`；无论是否 miss 都立刻返回 `quoteState.filter(product_ids, fields, updated_at)` 的结果（不再在同步路径强制 freshness）。",
        "队列模型：用 RxJS `Subject<UpdateTask>` 作为更新任务队列，消费者用 `concatMap` 串行处理（任务之间严格顺序执行）。",
        "UpdateTask 参数：`{ product_ids: string[]; fields: IQuoteKey[]; updated_at: number }`（建议在入队前对 `product_ids/fields` 做排序+去重以减少“同集合不同顺序”的重复任务）。",
        "单任务执行：处理时重新 `computeCacheMissed(quoteState, task.product_ids, task.fields, task.updated_at)`；若仍非空则调用 `quoteProviderRegistry.fillQuoteStateFromUpstream({ quoteState, cacheMissed, updated_at: task.updated_at })`；为空则 no-op。",
        "鲁棒性：队列内任何一次 `fillQuoteStateFromUpstream` 抛错都不能导致队列停止（在 inner observable `catchError` 吞掉并记录日志），并避免输出过大的 `product_ids/actions` JSON。",
        "`updated_at` 讨论：在 SWR 语义下它更像 `min_updated_at`（鲜度下界/容忍度），用于 miss 计算与过滤；若下游只是“尽量新”，可考虑未来把它变为可选并增加 `max_staleness_ms` 默认值（但这会改动契约，建议先保持必填）。",
        "性能评估：同步延迟显著下降（不再 await 上游）；后台会增加一次（甚至多次）miss 计算开销，但通常远小于上游 RPC；串行队列会降低并发、可能延长收敛时间，但能显著降低上游瞬时压力，并通过“执行时重新算 miss”对重复轮询天然去重（很多任务会 no-op）。可选增强：队列长度监控/报警，或对连续任务做合并（不在本次最小实现范围内）。"
      ],
      "scope": ["apps/virtual-exchange/src/quote/service.ts"],
      "phases": [
        {
          "name": "Discovery",
          "tasks": [
            {
              "description": "确认现状契约与调用方期望：\n- `VEX/QueryQuotes` 当前是否被任何调用方依赖“必须满足 updated_at freshness，否则抛错”的语义（目前 `assertFreshnessSatisfied` 会在缺字段时抛 `VEX_QUOTE_FRESHNESS_NOT_SATISFIED`）。\n- 轮询调用（例如 `.c1-cellar/vex-query-quotes.ts`）是否接受第一次返回缺字段/空结果并重试。\n- `quoteProviderRegistry.fillQuoteStateFromUpstream` 对字段不可用的 `defaultAction`（写 `\"\"` + `updated_at`）是否仍能减少重复 miss。\n输出：把需要保留/改变的对外语义列清单（尤其是是否要保留 strict 模式）。",
              "acceptance": "context.md 记录：现有语义（strict vs best-effort）、主要调用方行为、以及 SWR 变更的兼容性结论。"
            }
          ]
        },
        {
          "name": "Design",
          "tasks": [
            {
              "description": "设计 SWR 算法与队列实现细节（不写代码，只定接口/流程/边界）：\n\n## 1. 新的 `VEX/QueryQuotes` 同步路径\n- 输入：`{ product_ids, fields, updated_at }`\n- 步骤：\n  1) `cacheMissed = computeCacheMissed(quoteState, product_ids, fields, updated_at)`（总是计算）\n  2) 若 `cacheMissed.length > 0`：`updateQueue$.next({ product_ids, fields, updated_at })`\n  3) 直接 `return quoteState.filter(product_ids, fields, updated_at)`\n- 语义：SWR/best-effort，不保证本次调用满足 freshness（因此不能在同步路径 assert/throw）。\n\n## 2. UpdateTask 定义\n- `type UpdateTask = { product_ids: string[]; fields: IQuoteKey[]; updated_at: number }`\n- 规范化建议（减少重复任务）：\n  - `product_ids = uniq(sort(product_ids))`\n  - `fields = uniq(sort(fields))`\n  - 不改变外部返回顺序语义（因为 filter 输出是对象，顺序不敏感）。\n\n## 3. 队列消费（严格顺序执行）\n- `const updateQueue$ = new Subject<UpdateTask>()`\n- `updateQueue$.pipe(concatMap(task => defer(() => processTask(task)).pipe(catchError(...))))\n  .subscribe()`\n- `processTask(task)`：\n  1) `cacheMissed2 = computeCacheMissed(quoteState, task.product_ids, task.fields, task.updated_at)`\n  2) 若为空：return（no-op）\n  3) 否则：`await quoteProviderRegistry.fillQuoteStateFromUpstream({ quoteState, cacheMissed: cacheMissed2, updated_at: task.updated_at })`\n- 错误处理：单任务失败只记日志（含 task 摘要、error code），不影响后续任务。\n\n## 4. 关于 `updated_at` 是否必要\n- 保留的理由：\n  - 它是“鲜度下界”而不是“想要最新”的绝对时间点；调用方可用 `Date.now() - 容忍延迟` 表达可接受的最大陈旧。\n  - 它让 VEX 能决定是否需要补全（miss 判断）以及返回哪些字段（filter）。\n- 潜在问题：调用方若传 `Date.now()` 会导致永远 miss（因为上游 quote.updated_at 不可能稳定 >= now），需要文档/示例约束。\n- 可选演进（不建议本次做）：\n  - 改名为 `min_updated_at`；或让 `updated_at` 可选并新增 `max_staleness_ms` 默认值，VEX 内部计算 `min_updated_at = Date.now() - max_staleness_ms`。\n\n## 5. 性能与风险评估\n- 预期收益：降低 `QueryQuotes` p99 延迟（无 await 上游），并通过串行队列降低上游峰值压力。\n- 潜在成本：\n  - 背景任务会重复做 miss 计算（O(product_ids * fields)），但通常远小于 RPC 成本。\n  - 串行队列可能产生 backlog（高频轮询 + 上游慢），导致“收敛时间”变长。\n- 风险兜底（可选，不在最小实现强制）：\n  - 队列长度监控（例如计数器+周期日志/报警）；\n  - 合并策略：在消费者侧把相邻任务 union 成更大的一次补全（但会增加实现复杂度，且需再确认是否符合你的“立即 push”语义）。\n\n输出：plan.md 固化上述流程、以及是否保留 strict 模式（例如另开 `VEX/QueryQuotesStrict`）。",
              "acceptance": "plan.md 给出：同步路径/后台队列/错误语义/updated_at 取舍/性能风险与可选兜底的明确结论。"
            }
          ]
        },
        {
          "name": "Implementation",
          "tasks": [
            {
              "description": "在 `apps/virtual-exchange/src/quote/service.ts` 落地 SWR：新增 `Subject<UpdateTask>` + 串行消费者；调整 `VEX/QueryQuotes` 不再 await 上游，只 enqueue 并立即返回 filter 结果。",
              "acceptance": "手工验证：首次查询可能返回缺字段；随后轮询同样 `updated_at` 能逐步收敛；并确认不会因单次上游失败导致队列停转。"
            }
          ]
        },
        {
          "name": "Validation",
          "tasks": [
            {
              "description": "最小验证：运行 prettier；本地用 `.c1-cellar/vex-query-quotes.ts` 轮询观察返回从空/部分逐步变完整，并确认日志没有爆量。",
              "acceptance": "格式无噪音；行为符合 SWR 预期；无明显内存增长/队列停止。"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2025-12-17T08:42:34.507Z",
      "status": "approved",
      "decidedAt": "2025-12-17T08:48:48.898Z",
      "decidedBy": "Claude",
      "createdTaskId": "task-vex-queryquotes-swr"
    },
    {
      "id": "proposal-mjck8ymi-a542af",
      "name": "review-new-scheduler-design",
      "goal": "审视 virtual-exchange/src/quote/upstream/new.ts 新调度器设计的合理性，针对 20,000 products 规模场景进行复杂度分析并提出优化建议",
      "rationale": "用户需要对新调度器设计进行架构审视，评估其在大规模场景（20,000 products × 7 fields = 140,000 cells）下的可行性。当前实现存在 O(n²) 复杂度问题，需要系统性记录问题和优化建议，便于后续实现参考。",
      "points": [
        "Cell-based Dirty Check 模型分析",
        "复杂度评估：O(n²) markDirty、O(n log n) 调度循环",
        "接口设计问题：全局可变状态、route 语义、services 同步",
        "流程设计问题：触发频率、无限循环风险、冗余操作",
        "数据结构优化建议：Map 替代 Array、倒排索引、优先队列"
      ],
      "scope": [
        "apps/virtual-exchange/src/quote/upstream/new.ts",
        "apps/virtual-exchange/src/quote/upstream/new.test.ts"
      ],
      "phases": [
        {
          "name": "架构审视",
          "tasks": [
            {
              "description": "分析 Cell 模型和 Dirty Check 流程设计",
              "acceptance": "完成流程图和核心模型描述"
            },
            {
              "description": "复杂度分析（20,000 products × 7 fields 场景）",
              "acceptance": "完成各操作的时间/空间复杂度表格"
            },
            {
              "description": "接口设计问题识别",
              "acceptance": "列出 cells/services/route 等接口的设计缺陷"
            },
            {
              "description": "流程设计问题识别",
              "acceptance": "列出 handleServiceGroupId/handleService 的问题"
            }
          ]
        },
        {
          "name": "优化建议",
          "tasks": [
            {
              "description": "提出数据结构优化方案",
              "acceptance": "完成 Map/Set/PriorityQueue 替代方案设计"
            },
            {
              "description": "提出索引结构优化方案",
              "acceptance": "完成 dirtyByGroup/servicesByPrefix 索引设计"
            },
            {
              "description": "总结优化收益",
              "acceptance": "完成优化前后复杂度对比表"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2025-12-19T07:41:19.050Z",
      "status": "approved",
      "decidedAt": "2025-12-19T07:42:29.750Z",
      "decidedBy": "Claude",
      "createdTaskId": "review-new-scheduler-design"
    },
    {
      "id": "proposal-mjcvo7jl-fdeab2",
      "name": "移除 Telegram 遗留代码（前后端）并清理重构命名",
      "goal": "彻底移除前后端 Telegram 相关遗留代码，清理/重构命名，并确保构建与核心功能保持正常。",
      "rationale": "仓库内存在 Telegram 遗留实现与命名（例如前端 telegram widget 目录、后端相关类型/路由的可能引用），会带来维护成本、误导新开发、以及潜在安全/合规与配置负担；该任务用于系统性清理并通过构建/类型检查验证无残留，降低后续迭代风险。",
      "points": [
        "优先删除不可达/无用代码，避免留下空壳引用",
        "对外兼容策略先写入 `context.md` 再动代码（避免误删关键接口）",
        "重构改名以“语义真实、边界清晰”为准（不要为了改名而改名）",
        "每次删除/重构后运行对应的 build/typecheck，减少回归面"
      ],
      "scope": [
        "frontend/src/components/telegram-weidget/**",
        "backend/src/**（含 type、路由/服务/配置 等）",
        "项目配置与文档（README/示例 env/PROJECT_DESIGN 等，如涉及）"
      ],
      "phases": [
        {
          "name": "盘点与影响面确认",
          "tasks": [
            {
              "description": "全仓库检索 `telegram`/`tg`/`bot`/`webhook`/`t.me`/相关环境变量，列出需要删除/替换的文件、路由、组件、类型与配置。",
              "acceptance": "形成明确的删除/替换清单（文件路径+用途+依赖点），并在 `context.md` 记录风险与回滚点。"
            },
            {
              "description": "确认当前产品需求：Telegram 功能是否完全下线；是否需要保留通用的 OAuth/登录/通知等非 Telegram 能力；对外 API 是否需要向后兼容（保留空实现/返回错误）。",
              "acceptance": "在 `context.md` 记录约束/决策：哪些能力保留、哪些必须删除、兼容策略（如有）。"
            }
          ]
        },
        {
          "name": "后端移除与重构",
          "tasks": [
            {
              "description": "移除后端 Telegram 相关：路由/控制器/服务/队列任务/webhook 处理、类型定义、配置与环境变量读取；同步清理未使用依赖与导出。",
              "acceptance": "`backend` 中无 Telegram 相关可达代码路径；构建/类型检查通过；启动不再要求 Telegram 相关 env。"
            },
            {
              "description": "如果存在对外 API 或 DB 表字段依赖 Telegram（如 user.telegramId），按决策进行迁移：删除字段/保留但不再使用/兼容返回；更新类型与校验。",
              "acceptance": "DB/类型/API 一致；无运行时因缺字段/缺类型导致的错误。"
            },
            {
              "description": "重构改名：将历史遗留的 Telegram 命名（变量/类型/文件名）替换为更通用的命名（如 `messaging`/`integration`/`externalAuth`），避免误导。",
              "acceptance": "后端公开接口/内部模块命名不再含 Telegram 语义（除非明确需要兼容）。"
            }
          ]
        },
        {
          "name": "前端移除与重构",
          "tasks": [
            {
              "description": "移除前端 Telegram 相关组件与页面逻辑（例如 `frontend/src/components/telegram-weidget`），以及任何与其耦合的状态、hooks、路由入口与样式资源。",
              "acceptance": "`frontend` 构建通过；页面不再渲染 Telegram Widget；无死代码/未使用导入。"
            },
            {
              "description": "重构改名：如果现有功能实际是“通用第三方登录/引导”，将 UI 文案与组件命名调整为通用语义；修正明显的拼写遗留（如 `weidget`）。",
              "acceptance": "前端组件/文件命名与实际功能一致；不再出现 `telegram`/`weidget` 等误导性命名（除非作为迁移兼容层）。"
            }
          ]
        },
        {
          "name": "清理、验证与文档",
          "tasks": [
            {
              "description": "清理依赖与配置：移除 Telegram 相关 npm/pnpm 依赖、后端依赖、环境变量示例/README/设计文档中的引用；保证 lint/format 规则不新增噪声。",
              "acceptance": "依赖树中无 Telegram 专用依赖（如有需要保留需在 `context.md` 说明）；配置与文档无 Telegram 引用。"
            },
            {
              "description": "增加/更新最小验证：后端类型检查/单测（如已有）、前端 build；补充一个“无 Telegram 依赖”检查（如 `rg telegram` 零命中或仅剩变更日志）。",
              "acceptance": "验证命令全部通过；仓库内不再残留 Telegram 代码（允许历史变更记录/迁移说明）。"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2025-12-19T13:01:06.226Z",
      "status": "approved",
      "decidedAt": "2025-12-19T13:01:53.394Z",
      "decidedBy": "Claude",
      "createdTaskId": "telegram"
    },
    {
      "id": "proposal-mjcx965k-d0047d",
      "name": "@yuants/exchange 增加 OHLC/InterestRate 历史数据写入服务",
      "goal": "在 @yuants/exchange 中新增 OHLC 与 InterestRate 历史数据写入服务（schema 元信息可解析、分页拉取、写入 SQL）。",
      "rationale": "现有历史数据获取在各 vendor 内部存在多套实现（如 createSeriesProvider / QuerySeriesFromTimeBackward + Update 写库），缺少统一的“能力声明 + schema 元信息解析 + 只写库不回传数据”的 SDK 入口；新增 provideOHLCService / provideInterestRateService 可以让 VEX/调度侧按 exchange.md 的规范统一发现能力、驱动分页拉取，并把数据稳定落到 `ohlc`/`interest_rate` 表。",
      "points": [
        "参考 `libraries/exchange/src/quote.ts` 的 schema 校验与 metadata 解析模式",
        "参考 `docs/zh-Hans/code-guidelines/exchange.md` 的“历史数据获取”章节定义翻页元信息（方向/游标类型/Inclusive/Exclusive/页码降级等）",
        "为 OHLC 定义 `IOHLCServiceMetadata`（含 `product_id_prefix`、RFC3339 `duration_list`、翻页策略 metadata）并提供 `parseOHLCServiceMetadataFromSchema`",
        "在 `provideOHLCService` 中注册一个写库服务：按请求参数拉取“一页”数据并写入 `ohlc` 表，不通过 API 返回数据本体",
        "每次写入同时落一条“本次拉取范围”记录（series_id/product_id/start_time/end_time 等），用于后续调度/排障（需要确认表名与 schema，必要时补 migration）",
        "同样实现 `interest_rate.ts`（`provideInterestRateService` + metadata + schema 解析），逻辑与 OHLC 对齐",
        "补齐 `libraries/exchange/src/index.ts` 导出并保持命名一致、无 vendor 耦合"
      ],
      "scope": [
        "libraries/exchange/src/ohlc.ts",
        "libraries/exchange/src/interest_rate.ts",
        "libraries/exchange/src/index.ts",
        "docs/zh-Hans/code-guidelines/exchange.md（如需补充接口/元信息说明）",
        "tools/sql-migration/sql（如需新增“拉取范围记录”表）"
      ],
      "phases": [
        {
          "name": "调研",
          "tasks": [
            {
              "description": "阅读并总结现有模式：`libraries/exchange/src/quote.ts`（schema->metadata）、`docs/zh-Hans/code-guidelines/exchange.md`（历史数据翻页语义）、以及 vendor 侧历史数据写库实现（如 `apps/vendor-okx/src/utils/provideSeriesFromTimeBackwardService.ts`、`libraries/data-series/src/index.ts`）。",
              "acceptance": "在 `context.md` 记录：可复用的 schema 校验模式、分页语义要点、以及现有写库方式优缺点（requestSQL vs createSQLWriter/writeToSQL）。"
            }
          ]
        },
        {
          "name": "设计",
          "tasks": [
            {
              "description": "设计 `IOHLCServiceMetadata`：`product_id_prefix`、`duration_list`（RFC3339 duration 字符串数组）、以及翻页策略（方向、cursor 类型：time/id/page/none、Inclusive/Exclusive 等）。同时确定 `provideOHLCService` 的请求/响应 schema（响应不含数据本体，但需能携带 next cursor / count 等最小信息以支持调度）。",
              "acceptance": "在 `context.md` 写清：metadata 类型定义（含翻页 union 结构）、request/response schema 草案、以及与 exchange.md 术语的一一对应关系。"
            },
            {
              "description": "定义并实现 `parseOHLCServiceMetadataFromSchema`：从 terminal service info 的 JSON Schema 中解析 metadata（对 schema 做结构校验，错误码与 `quote.ts` 一致风格）。",
              "acceptance": "在 `context.md` 写清解析规则与校验点（必填字段、duration_list 来源、翻页策略来源、兼容/扩展策略）。"
            },
            {
              "description": "确认“拉取范围记录”表的落点：是否复用现有表（如 `series_collecting_task` 不适用），还是新增独立表（建议 `history_fetch_log`/`series_fetch_log` 之类）。同步确定记录字段：series_id/product_id/duration?/start_time/end_time/created_at/terminal_id 等。",
              "acceptance": "输出一个明确决策：表名 + 字段 + conflict key/索引；若需新增 migration，写明文件名与回滚策略。"
            }
          ]
        },
        {
          "name": "实现",
          "tasks": [
            {
              "description": "实现 `libraries/exchange/src/ohlc.ts`：提供 `provideOHLCService`（内部用 `createSQLWriter`/`requestSQL` 将每页数据写入 `ohlc`，不回传数据本体；并写入“拉取范围记录”表），以及导出的 metadata/type/parse 函数。",
              "acceptance": "代码可被 vendor/VEX 调用；请求 schema 能限制 product_id/duration/cursor；服务响应只包含最小调度信息（如 next cursor/count）。"
            },
            {
              "description": "实现 `libraries/exchange/src/interest_rate.ts`：与 OHLC 同结构（metadata + parse + provideInterestRateService），写入 `interest_rate` 表及范围记录表。",
              "acceptance": "接口命名与结构与 OHLC 一致；写库冲突键正确（series_id+created_at）。"
            },
            {
              "description": "更新 `libraries/exchange/src/index.ts` 导出新增模块，并保持对外 API 一致、无 vendor 假设。",
              "acceptance": "`@yuants/exchange` 对外可直接 import 新增导出；类型与函数命名清晰。"
            }
          ]
        },
        {
          "name": "验证与文档",
          "tasks": [
            {
              "description": "添加最小自测/示例（若仓库有既定方式则按既定）：验证 schema 解析（parseMetadataFromSchema）在典型 schema 上可工作，并验证写库 SQL 的 conflict keys 与字段匹配 `tools/sql-migration/sql/ohlc.sql`/`interest_rate.sql`。必要时补充 `exchange.md` 的接口/metadata 说明。",
              "acceptance": "本地 typecheck/build 通过；文档或注释说明清楚如何声明能力与如何被 VEX 解析。"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2025-12-19T13:45:23.817Z",
      "status": "approved",
      "decidedAt": "2025-12-19T13:45:29.155Z",
      "decidedBy": "Claude",
      "createdTaskId": "yuantsexchange-ohlcinterestrate"
    },
    {
      "id": "proposal-mjdworxq-9b3610",
      "name": "vendors-ingest-ohlc-interest-rate",
      "goal": "在各 vendor 中新增基于 `@yuants/exchange` 的 `IngestOHLC` / `IngestInterestRate` 写库服务（`provideOHLCService` / `provideInterestRateService`），供 VEX 统一调度历史数据。",
      "rationale": "当前各 vendor 多为 `@yuants/data-series` 的 `createSeriesProvider` 风格，接口不统一且部分直接写库；而 `yuantsexchange-ohlcinterestrate` 已在 `@yuants/exchange` 收敛了历史数据写库服务的统一 contract（`product_id + time + direction` + schema->metadata 解析 + `series_data_range` 记录）。需要把各 vendor 的历史数据拉取能力适配到该 contract，便于 VEX 发现能力并按 metadata 路由/调度。",
      "points": [
        "以 `yuantsexchange-ohlcinterestrate` 的接口语义为准：request 必含 `time` + `direction`，服务返回 `wrote_count + range`，不回传数据本体",
        "各 vendor 的实现参考其 `src/services/quotes.ts` 的组织方式：`Terminal.fromNodeEnv()` + 顶层注册多个 service",
        "优先复用现有 vendor 的历史数据实现/映射（如 OKX/BINANCE 的 `public-data/*`、BITGET/HYPERLIQUID 的 `services/markets/*`）来实现 `fetchPage`",
        "明确每个 vendor 支持的 `product_id_prefix`、OHLC `duration_list`、以及 `direction`（必要时同一 vendor 提供多个 prefix/方向的 service）",
        "对仅支持“页码翻页/单页”的交易所（如 BITGET/HTX/GATE 的资金费率历史）先输出清晰决策：桥接到 `time` 语义或暂不接入本次 ingest contract"
      ],
      "scope": [
        "libraries/exchange/src/ohlc.ts（接口参考）",
        "libraries/exchange/src/interest_rate.ts（接口参考）",
        "apps/vendor-aster/src/services/ohlc-service.ts（新增）",
        "apps/vendor-aster/src/services/interest-rate-service.ts（新增）",
        "apps/vendor-binance/src/services/ohlc-service.ts（新增）",
        "apps/vendor-binance/src/services/interest-rate-service.ts（新增）",
        "apps/vendor-bitget/src/services/ohlc-service.ts（新增）",
        "apps/vendor-bitget/src/services/interest-rate-service.ts（新增）",
        "apps/vendor-gate/src/services/ohlc-service.ts（新增）",
        "apps/vendor-gate/src/services/interest-rate-service.ts（新增）",
        "apps/vendor-huobi/src/services/ohlc-service.ts（新增）",
        "apps/vendor-huobi/src/services/interest-rate-service.ts（新增）",
        "apps/vendor-hyperliquid/src/services/ohlc-service.ts（新增）",
        "apps/vendor-hyperliquid/src/services/interest-rate-service.ts（新增）",
        "apps/vendor-okx/src/services/ohlc-service.ts（新增）",
        "apps/vendor-okx/src/services/interest-rate-service.ts（新增）",
        "apps/vendor-*/src/api/*（如需补齐 OHLC/利率历史接口 wrapper）"
      ],
      "phases": [
        {
          "name": "调研",
          "tasks": [
            {
              "description": "阅读并总结 `yuantsexchange-ohlcinterestrate` 的接口约定，并对照代码确认 `provideOHLCService` / `provideInterestRateService` 的 request/metadata/schema 细节（time+direction、duration enum、product_id_prefix pattern、range 计算与写库表）。",
              "acceptance": "在 task `context.md` 写清：两个 service 的 schema/metadata 字段含义、series_id 编码规则、以及 vendor 实现时需要满足的输入输出约束。"
            },
            {
              "description": "逐个 vendor（ASTER/BINANCE/BITGET/GATE/HTX/HYPERLIQUID/OKX）盘点现有历史数据实现与可复用函数：已存在的 duration 映射、分页方式（time/endTime/startTime/page/one-page）、以及当前 product_id 编码约定。",
              "acceptance": "在 `context.md` 记录每个 vendor：OHLC/InterestRate 是否已有 API wrapper、可复用的映射表、推荐的 direction（forward/backward）、以及需要补齐的缺口。"
            }
          ]
        },
        {
          "name": "设计",
          "tasks": [
            {
              "description": "为每个 vendor 输出一份“能力矩阵”：要注册哪些 `provideOHLCService`/`provideInterestRateService`（按 product_id_prefix 划分），各自 `direction` 选择、OHLC 的 `duration_list`、以及 `fetchPage` 如何把 `time` 映射到交易所参数（after/endTime/startTime/cursor）。",
              "acceptance": "在 `context.md` 给出最终矩阵与关键决策（包含 page-only/one-page 的处理策略），并列出每个 vendor 预计新增/修改的文件清单。"
            }
          ]
        },
        {
          "name": "实现",
          "tasks": [
            {
              "description": "在各 vendor 的 `src/services/` 新增 `ohlc-service.ts` 与 `interest-rate-service.ts`，参考 `quotes.ts` 的结构注册服务，并用 vendor API 实现 `fetchPage`（含 duration 映射、decodePath(product_id) 路由、limit/time/direction 参数处理）。",
              "acceptance": "每个 vendor 启动后能注册对应的 `IngestOHLC`/`IngestInterestRate` 服务；schema 的 `product_id` pattern、OHLC `duration` enum、`direction const` 与设计一致。"
            },
            {
              "description": "对缺失的交易所接口 wrapper（如 ASTER/GATE/HTX 的 OHLC 端点或缺少的参数）补齐 `src/api/*`，并复用仓库现有 http-client/rate-limiter 模式。",
              "acceptance": "`fetchPage` 不再包含临时代码/硬编码 URL；API wrapper 有类型定义且可复用。"
            }
          ]
        },
        {
          "name": "验证",
          "tasks": [
            {
              "description": "本地做最小验证：TypeScript typecheck/build；并用脚本/小段调用验证服务注册的 schema 可被 `parseOHLCServiceMetadataFromSchema`/`parseInterestRateServiceMetadataFromSchema` 正确解析（至少覆盖一个 vendor 的典型 schema）。",
              "acceptance": "`pnpm/rush` 的 typecheck/build 通过；记录一份“如何手工验证服务注册”的步骤到 `context.md` 快速交接。"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2025-12-20T06:17:18.446Z",
      "status": "approved",
      "decidedAt": "2025-12-20T06:17:22.445Z",
      "decidedBy": "Claude",
      "createdTaskId": "vendors-ingest-ohlc-interest-rate"
    },
    {
      "id": "proposal-mjft6t6y-5f10f9",
      "name": "alert-receiver 修复 resolve/repeat 加急与去重",
      "goal": "修复 alert-receiver 的 resolve/repeat 通知在加急与重复发送上的逻辑错误，确保只更新原有消息并按规则重复加急。",
      "rationale": "当前 alert-receiver 在告警已解决（resolve）时也会触发“加急”，且 resolve/repeat 场景会重复发送新消息，造成频道噪音与错误提醒；需要把 resolve 的提示语义与消息更新/加急策略做成确定、可预测的行为。",
      "points": [
        "resolve 状态不应触发“加急/紧急”",
        "resolve 的重复通知应更新同一条 message（edit/update），不应发送新 message",
        "repeat 场景不应重复发新 message，而是对原 message 进行“重复加急”（例如再次提醒/更新加急状态/时间戳）",
        "对 dedupe 的 key/存储策略做最小必要调整，避免回归 firing 场景",
        "补充最小单测/集成测试覆盖 resolve/repeat 去重与更新行为"
      ],
      "scope": ["apps/alert-receiver/src/**", "docs/zh-Hans/monitoring-alerting.md（如需补充行为说明）"],
      "phases": [
        {
          "name": "调研与复现",
          "tasks": [
            {
              "description": "梳理 alert-receiver 的消息生命周期：firing→repeat→resolve 的状态机、messageId/threadId 的存储与 dedupe key 生成方式，并用最小输入复现 resolve 也加急、resolve/repeat 重复发消息的问题。",
              "acceptance": "在任务 context 记录：触发条件、当前错误行为的代码路径、以及期望行为的规则（含边界条件）。"
            }
          ]
        },
        {
          "name": "实现修复",
          "tasks": [
            {
              "description": "调整 resolve 的处理：禁止进入加急路径；并确保 resolve 只会更新已有 message（不存在则按策略补发一次或记录告警）。",
              "acceptance": "resolve 不再触发加急；resolve 事件不会产生同一告警的多条消息。"
            },
            {
              "description": "调整 repeat 的处理：不再发送新 message；改为对原 message 执行更新并触发“重复加急”（例如更新卡片/追加提示/刷新加急标记）。",
              "acceptance": "repeat 不产生新 message；重复触发时只会对同一 message 做可观察的重复加急更新。"
            }
          ]
        },
        {
          "name": "验证与回归",
          "tasks": [
            {
              "description": "为 resolve/repeat 的去重与 update 行为补充测试（优先对消息发送器/存储层做 mock），并做一次本地最小运行验证。",
              "acceptance": "新增测试覆盖 3 个 bug 点且通过；记录手工验证步骤到 context 快速交接。"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2025-12-21T14:14:53.770Z",
      "status": "approved",
      "decidedAt": "2025-12-21T14:29:28.426Z",
      "decidedBy": "Claude",
      "createdTaskId": "alert-receiver-resolverepeat"
    },
    {
      "id": "proposal-mjftw6kb-ad40b0",
      "name": "多账户切换：新增切换账户弹窗并保留本地凭据",
      "goal": "在导航栏新增“切换账户”功能，支持添加新账号并在多个 Supabase 登录账号间切换，同时历史账号凭据保留在 localStorage 中。",
      "rationale": "当前前端仅支持单账号登录/退出（Supabase 单 session），用户需要在同一设备上管理多个账号并快速切换；同时要求新增账号仍走现有 Email+OTP 登录流程，并在切换/退出时保留历史账号凭据在 localStorage 以便随时切回。",
      "points": [
        "在用户菜单（退出登录上方）新增“切换账户”入口",
        "设计并实现用于切换/添加账户的 Modal",
        "新增账户必须走现有登录流程（/login 的 Email+OTP）",
        "切换/退出时不删除历史账号凭据，本地可随时切回",
        "将当前账号的 session 在 TOKEN_REFRESHED 等事件中持续同步到本地存储，保证可用性"
      ],
      "scope": [
        "frontend/src/components/header/index.tsx",
        "frontend/src/pages/login/index.tsx",
        "frontend/src/hooks/useAuth.ts",
        "frontend/src/library/request.ts",
        "frontend/src/library/supabase.ts",
        "frontend/src/components/(new) account-switcher modal",
        "frontend/src/library/(new) multi-account session store"
      ],
      "phases": [
        {
          "name": "调研与方案确认",
          "tasks": [
            {
              "description": "复核现有登录/退出入口与 Supabase session 持久化行为（useAuth、LoginPage、Header、request.ts 401 处理）",
              "acceptance": "明确 session 来源、更新时机、退出行为；确认可通过 `supabase.auth.setSession` 进行会话切换"
            },
            {
              "description": "确定 localStorage 数据结构与 key（含版本字段、字段安全性、迁移策略）",
              "acceptance": "形成明确的数据模型与 key 命名，并列出兼容/迁移规则（例如 v1 结构）"
            }
          ]
        },
        {
          "name": "多账户存储与切换逻辑",
          "tasks": [
            {
              "description": "新增 multi-account session store（localStorage 读写、schema 校验、upsert、lastUsedAt 更新）",
              "acceptance": "可在本地保存多个账户的 session（至少包含 email/userId/refresh_token/expires_at）；重复登录同一账户会更新记录"
            },
            {
              "description": "在 `useAuth` 的 `onAuthStateChange` 中对 SIGNED_IN/TOKEN_REFRESHED/USER_UPDATED 等事件同步更新 store",
              "acceptance": "活跃账户 token 刷新后，本地保存的对应 session 记录会随之更新，避免切回时 refresh_token 过期"
            },
            {
              "description": "实现 `switchToAccount`：从 store 取目标 session 调用 `supabase.auth.setSession` 并处理失败场景",
              "acceptance": "可在不走登录页的情况下切换到已保存账户；失败时给出明确提示且不删除本地记录"
            },
            {
              "description": "调整“退出登录”逻辑与 401 强制登出逻辑：登出只影响当前会话，不清理 multi-account store",
              "acceptance": "退出登录后 localStorage 中的历史账号记录仍在；重新登录/切换可继续使用"
            }
          ]
        },
        {
          "name": "UI：Header 入口与切换 Modal",
          "tasks": [
            {
              "description": "在 `Header` 的用户下拉菜单中，在“退出登录”上方新增“切换账户”项并打开 Modal",
              "acceptance": "已登录时可看到“切换账户”入口；点击打开弹窗且不影响现有菜单项"
            },
            {
              "description": "实现切换账户 Modal：展示当前账户、已保存账户列表、切换动作、添加账户入口",
              "acceptance": "可从列表选择并切换；当前账户有清晰标识；提供“添加账户”按钮/链接"
            },
            {
              "description": "接入“添加账户”流程：从 Modal 跳转 `/login` 走 Email+OTP；登录成功后写入 store 并返回来源页面（或默认页）",
              "acceptance": "添加新账号不依赖 Modal 内登录；登录成功后能在 Modal 中看到新账号且可切换；返回路径符合设计"
            }
          ]
        },
        {
          "name": "验证与回归",
          "tasks": [
            {
              "description": "覆盖关键手测场景：添加两个账号、在两者间切换、刷新页面后仍可切换、退出登录后账号列表仍保留",
              "acceptance": "上述场景在浏览器中验证通过，且不会出现“凭据被清空/丢失”"
            },
            {
              "description": "验证异常与边界：目标 session 失效/refresh_token 过期、401 触发强制登出、localStorage 数据损坏",
              "acceptance": "出现异常时有 toast 提示；不会 crash；不会删除历史记录；可引导用户重新走登录流程恢复该账号"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2025-12-21T14:34:37.499Z",
      "status": "approved",
      "decidedAt": "2025-12-21T14:34:42.022Z",
      "decidedBy": "Claude",
      "createdTaskId": "task-42a439ec"
    },
    {
      "id": "proposal-mjgtfwj3-549740",
      "name": "VEX series-data 调度器（OHLC/InterestRate）+ ohlc_v2 迁移",
      "goal": "在 virtual-exchange 新增 series-data 调度器，自动调度各 vendor 的 IngestOHLC/IngestInterestRate 进行拉新与回补，并改造 @yuants/exchange 的 OHLC 写库到新表 ohlc_v2（含 migration 与索引）。",
      "rationale": "现有 vendor 已按 @yuants/exchange contract 注册 IngestOHLC/IngestInterestRate，但缺少 VEX 侧统一调度：需要按“当前时间优先拉新 + 闲暇向过去回补”的策略持续写库；同时 ohlc 表字段冗余（datasource_id/product_id/duration 已编码在 series_id），需迁移到更紧凑的 ohlc_v2 并对齐写库与索引。",
      "points": [
        "对齐 vendors-ingest-ohlc-interest-rate 与 @yuants/exchange ingest contract（time+direction、schema->metadata 解析、range 语义）",
        "在 VEX 内发现所有 IngestOHLC/IngestInterestRate 服务并建立能力分组/实例池",
        "调度策略：优先拉新（接近 now），闲暇回补（根据 series_data_range 向过去推进），包含全局/分组并发限制与 backoff",
        "series_data_range 同 (series_id, table_name) 重叠区间在 transaction 中可合并，避免范围碎片爆炸",
        "@yuants/exchange: OHLC_INSERT_COLUMNS 移除 datasource_id/product_id/duration；写入新表 ohlc_v2；并写 migration（series_id+created_at 索引）",
        "若调度所需信息不足，提出最小新增 metadata（schema 非必填 const 字段）供 review"
      ],
      "scope": [
        "apps/virtual-exchange/src/index.ts",
        "apps/virtual-exchange/src/(new) series-data/*",
        "libraries/exchange/src/ohlc.ts",
        "tools/sql-migration/sql/ohlc_v2.sql",
        "tools/sql-migration/sql/series_data_range.sql（可能仅新增索引/不改表结构）"
      ],
      "phases": [
        {
          "name": "调研与对齐",
          "tasks": [
            {
              "description": "复核 ingest contract 与 VEX 现有调度模式：IngestOHLC/IngestInterestRate 的 schema->metadata 解析、time+direction 语义、range 计算与写入 series_data_range；参考 VEX quote scheduler 的 service 发现与 runner 模型",
              "acceptance": "在 context.md 记录：两类 ingest 服务的能力矩阵抽象、VEX 侧可复用的发现/并发/队列模式、以及调度所需的最小输入（目标 series 来源、表名映射、推进规则）"
            },
            {
              "description": "盘点现有表结构与迁移规范：series_data_range 主键/索引；ohlc/interest_rate 现状；明确 ohlc_v2 的字段/索引/trigger 需求与迁移策略（仅建表，不做数据搬迁）",
              "acceptance": "在 plan.md 写清：ohlc_v2 DDL（幂等）、索引、trigger；并列出代码侧写库要点（OHLC_INSERT_COLUMNS 与 table_name/range 同步）"
            }
          ]
        },
        {
          "name": "设计（先评审）",
          "tasks": [
            {
              "description": "设计 series-data 模块的结构与对外调试入口：服务发现（terminalInfos$）、能力分组（method+meta）、series 枚举（基于 product 表 prefix + duration_list 组合 / 或新增配置表方案对比）、状态缓存（range union）",
              "acceptance": "plan.md 给出模块文件划分、核心数据结构（ProviderGroup/SeriesKey/Job）、以及 2 套 series 来源方案（全量 product 扫描 vs 新增配置表）并标注推荐与原因"
            },
            {
              "description": "设计调度算法：拉新(head) 与回补(tail) 两级优先队列；per-group 串行 + 全局并发；失败 backoff；推进规则仅依赖 range（不依赖 wrote_count）；支持 forward/backward 两种 direction",
              "acceptance": "plan.md 给出：选 job 的伪代码/状态机、关键边界（重复拉取/空页/无 range）、以及可配置项（并发、拉新频率、回补速率、最早回补时间）"
            },
            {
              "description": "设计 range 合并算法：同 (series_id, table_name) 的多条 range 读出后按 start_time 排序 merge；transaction 内 delete+insert（或 SQL CTE 聚合）保证并发安全",
              "acceptance": "plan.md 给出：merge 判定（overlap/adjacent）、复杂度、SQL transaction 方案（锁粒度/隔离级别建议）、以及和写入端（vendor ingest）并发时的幂等性说明"
            },
            {
              "description": "如需新增 metadata，提出最小字段并说明解析方式（通过 schema.properties.<field>.const，非 required）",
              "acceptance": "plan.md 列出候选字段与用途（例如 interest_rate 的 recommended_poll_interval_ms），并标注是否必须/可选；留出 REVIEW block"
            }
          ]
        },
        {
          "name": "实现",
          "tasks": [
            {
              "description": "在 apps/virtual-exchange 新增 series-data 模块：发现 IngestOHLC/IngestInterestRate 服务、枚举 series、执行 ingest 请求、读取/更新 series_data_range 并做 merge；接入 apps/virtual-exchange/src/index.ts 启动",
              "acceptance": "VEX 启动后可持续运行：周期性拉新；空闲时回补；日志/指标可观察；可通过 env 控制启停与并发"
            },
            {
              "description": "实现 ohlc_v2 migration 与 exchange 写库改造：新增 tools/sql-migration/sql/ohlc_v2.sql；修改 libraries/exchange/src/ohlc.ts 写入 ohlc_v2 且 range.table_name=ohlc_v2，并移除 datasource_id/product_id/duration 写入",
              "acceptance": "migration 幂等；写库字段与表结构匹配；(series_id, created_at) 冲突键与索引一致；不影响 InterestRate 现有链路"
            }
          ]
        },
        {
          "name": "验证与交接",
          "tasks": [
            {
              "description": "补充最小验证：range merge 单测或脚本；在可运行环境验证一次 end-to-end（发现服务->触发 ingest->写库->range 合并）；记录如何观察调度状态/排障",
              "acceptance": "tasks.md 记录可复现的验证步骤；context.md 写入快速交接（下一步/注意事项/回滚点）"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2025-12-22T07:09:44.175Z",
      "status": "approved",
      "decidedAt": "2025-12-22T07:09:48.363Z",
      "decidedBy": "Claude",
      "createdTaskId": "vex-series-data-ohlcinterestrate-ohlc-v2"
    },
    {
      "id": "proposal-mjk1o7kc-2adac7",
      "name": "Binance private-api 按 host 选择 tokenBucket 并按权重限流",
      "goal": "在 apps/vendor-binance 的 private-api 发起请求前，根据 URL host 选择对应的 tokenBucket，并按接口权重调用 acquireSync 做限流。",
      "rationale": "当前 private-api 可能对不同 host 的请求共用同一限流桶，无法匹配 Binance 文档对不同域名/接口权重的限制；按 host 路由到 client.ts 中已定义的 3 个 tokenBucket，并在请求前按权重 acquireSync，可避免触发限流并保持实现一致。",
      "points": [
        "复用 apps/vendor-binance/src/api/client.ts 中已定义的 3 个 tokenBucket（首次 create，后续仅用 bucketId 获取，不再传 options）",
        "在 private-api 里对每次请求解析 URL host，映射到对应 bucketId（未知 host 走默认 bucket，并在 metadata 记录）",
        "请求前 `bucket.acquireSync(weight)`；weight 来自方法文档注释中的“权重”",
        "用 `scopeError` 包装 metadata（host、pathname、method、weight、bucketId、query/hash 的安全摘录），token 不够时自动 throw，不捕获",
        "不改动公共 API；修改尽量局部并保持可读性",
        "补一个最小单测：给不同 host 的 URL 断言选择不同 bucketId + weight 被传入（可用 spy/mock）"
      ],
      "scope": [
        "apps/vendor-binance/src/api/private-api.ts",
        "apps/vendor-binance/src/api/client.ts",
        "apps/vendor-binance/src/api/__tests__/private-api.rateLimit.test.ts（如目录/测试框架已有）"
      ],
      "phases": [
        {
          "name": "调研",
          "tasks": [
            {
              "description": "阅读 apps/vendor-binance/src/api/client.ts 中 3 个 tokenBucket 的定义（bucketId/用途/参数），梳理 private-api 发请求的统一入口与 URL 生成方式，并确认方法注释里“权重”的表达形式",
              "acceptance": "context.md 记录：3 个 bucket 的 bucketId 与对应 host 范围；private-api 的请求入口位置；权重从注释到代码的映射方式"
            }
          ]
        },
        {
          "name": "设计（先让你 review）",
          "tasks": [
            {
              "description": "在 plan.md 写清 host->bucket 的映射规则、默认策略、以及 acquireSync 的统一封装函数；并给出一个可复制的使用示例（你要求的例子会写在 plan.md）",
              "acceptance": "plan.md 包含一个最小代码示例：给定 url/weight，如何选桶并 acquireSync；并留一个 REVIEW block 让你确认映射是否正确"
            }
          ]
        },
        {
          "name": "实现",
          "tasks": [
            {
              "description": "在 private-api 的请求发送前插入“选择 bucket + acquireSync(weight)”逻辑；用 scopeError 记录 metadata；确保调用 tokenBucket 时不重复传 options",
              "acceptance": "不同 host 的请求会命中不同 bucket；token 不足会 throw（不捕获）；metadata 中能看到 host/weight/bucketId"
            }
          ]
        },
        {
          "name": "验证",
          "tasks": [
            {
              "description": "补充/更新最小测试或脚本验证：不同 host 选择不同桶；weight 透传到 acquireSync；并运行相关 test/lint/tsc（取仓库现有最小可运行路径）",
              "acceptance": "新增测试通过；prettier 格式化无噪音；无明显类型错误"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2025-12-24T13:23:27.181Z",
      "status": "approved",
      "decidedAt": "2025-12-24T13:32:36.757Z",
      "decidedBy": "Claude",
      "createdTaskId": "binance-private-api-host-tokenbucket"
    },
    {
      "id": "proposal-mjk5y7i3-ba29d0",
      "name": "Aster public/private API 按 host 选择 tokenBucket 并主动限流",
      "goal": "在 apps/vendor-aster 的 public-api/private-api 发起请求前，根据 URL host 选择对应的 tokenBucket，并在请求前按权重调用 acquireSync 做限流。",
      "rationale": "Aster API 已在 Session Notes 标注容易触发 429；参考本次 Binance 的实现方式，把限流前置到每个具体 API 调用点，按 host 复用 tokenBucket 并记录 scopeError metadata，可减少 IP/账户被限速并提升可观测性。",
      "points": [
        "在模块初始化阶段创建按 host 区分的 tokenBucket（至少覆盖 fapi.asterdex.com / sapi.asterdex.com）",
        "public-api/private-api 每个具体 API 方法在 fetch 前执行：解析 endpoint 得到 url.host -> tokenBucket(url.host).acquireSync(weight)",
        "weight 优先来自接口注释/文档；若 Aster 文档未提供 weight，先统一按 1，并在 plan/context 记录待补齐点",
        "使用 scopeError 仅包裹 acquireSync，记录 metadata（method/endpoint/host/path/bucketId/weight/关键条件参数），token 不足直接 throw 不捕获",
        "新增最小单测：不同 host 选择不同 bucket；weight 透传到 acquireSync",
        "更新 apps/vendor-aster/SESSION_NOTES.md：记录改动摘要与本地验证命令/结果"
      ],
      "scope": [
        "apps/vendor-aster/src/api/private-api.ts",
        "apps/vendor-aster/src/api/public-api.ts",
        "apps/vendor-aster/src/api/(新增)rate-limit.ts 或 client.ts",
        "apps/vendor-aster/src/api/*rateLimit.test.ts（按现有测试框架落地）",
        "apps/vendor-aster/SESSION_NOTES.md",
        ".legion/tasks/<new-task>/plan.md",
        ".legion/tasks/<new-task>/context.md",
        ".legion/tasks/<new-task>/tasks.md"
      ],
      "phases": [
        {
          "name": "调研",
          "tasks": [
            {
              "description": "梳理 vendor-aster 的 baseURL host 列表与请求入口；确认 Aster 文档是否提供 weight/频率信息（或是否能从 exchangeInfo.rateLimits 推断）",
              "acceptance": "context.md 记录：涉及的 host 列表、每类 host 的限流桶配置来源/默认值、weight 规则（已知/未知）"
            }
          ]
        },
        {
          "name": "设计（先 review）",
          "tasks": [
            {
              "description": "在 plan.md 写清 host->bucket 规则、tokenBucket 创建位置与参数、以及每个 API 方法调用 acquireSync 的示例；留 REVIEW 给你确认",
              "acceptance": "plan.md 有可复制示例 + REVIEW block；你确认后再开始改代码"
            }
          ]
        },
        {
          "name": "实现",
          "tasks": [
            {
              "description": "落地 tokenBucket 初始化 + public-api/private-api 的每个具体 API 方法请求前 acquireSync(weight)（不抽 wrapper）；用 scopeError 注入 metadata",
              "acceptance": "所有 API 调用点都经过 acquireSync；不同 host 走不同 bucket；无多余抽象；异常不吞"
            }
          ]
        },
        {
          "name": "验证与交接",
          "tasks": [
            {
              "description": "补最小测试或脚本验证 host 路由与 weight；运行 tsc/测试并把结果写入 SESSION_NOTES 与 context 快速交接",
              "acceptance": "`npx tsc --noEmit --project apps/vendor-aster/tsconfig.json` 通过；相关测试通过；文档包含可复现命令"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2025-12-24T15:23:12.127Z",
      "status": "approved",
      "decidedAt": "2025-12-24T15:32:00.428Z",
      "decidedBy": "Claude",
      "createdTaskId": "aster-publicprivate-api-host-tokenbucket"
    },
    {
      "id": "proposal-mjlo00k5-ff52d3",
      "name": "Huobi public/private API tokenBucket：按业务与接口类型主动限流",
      "goal": "在 apps/vendor-huobi 的 public-api/private-api 发起请求前，按业务线（交割/币本位永续/U本位/现货）与接口类型（行情/非行情，交易/查询）选择对应 tokenBucket 并 acquireSync(1) 做主动限流。",
      "rationale": "Huobi/HTX 的公开与私有 REST 都有明确的 IP/UID 级访问上限；当前仓库已创建 tokenBucket 但未在请求前实际扣减，容易触发 429/封禁。将限流前置到 publicRequest/privateRequest，并按业务线拆分 bucket，可同时满足“交割/币本位永续/U本位分开限频”与“行情/非行情、交易/查询分开额度”的要求。",
      "points": [
        "复用你已在 public-api/private-api 创建的 bucket（必要时按业务线补齐命名与参数）；调用点只 acquireSync，不捕获 token 不足异常",
        "publicRequest：按 path 判断行情类 vs 非行情类；行情类按 1s/800（IP 维度），非行情按 3s/120（IP 维度）",
        "privateRequest：按 path/方法/语义判断交易 vs 查询；普通用户按 3s/36（trade）与 3s/36（query）（UID 维度，代码以 access_key 作为隔离 key）；并按业务线（交割/币本位永续/U本位）拆分桶",
        "交割合约/币本位永续/U本位/现货：根据 api_root + path 前缀（例如 /linear-swap-, /swap-, /contract- 等）与必要时的参数（contract_code/business_type）判断",
        "用 scopeError 包裹 acquireSync 记录 metadata（api_root/path/method/bucketId/type/business），异常直接 throw",
        "补最小单测：不同业务/接口类型会选择不同 bucket；并运行 vendor-huobi 的 tsc/heft test"
      ],
      "scope": [
        "apps/vendor-huobi/src/api/public-api.ts",
        "apps/vendor-huobi/src/api/private-api.ts",
        "apps/vendor-huobi/SESSION_NOTES.md（若存在）或等效上下文文件",
        ".legion/tasks/<new-task>/plan.md",
        ".legion/tasks/<new-task>/context.md",
        ".legion/tasks/<new-task>/tasks.md"
      ],
      "phases": [
        {
          "name": "调研",
          "tasks": [
            {
              "description": "梳理 vendor-huobi 现有 tokenBucket 定义与所有请求入口；列出业务线识别规则（交割/币本位永续/U本位/现货）与接口类型识别规则（行情/非行情、交易/查询）",
              "acceptance": "context.md 记录 bucket 列表（bucketId/参数/用途）、识别规则、以及不确定点与默认策略"
            }
          ]
        },
        {
          "name": "设计（先写文档）",
          "tasks": [
            {
              "description": "在 plan.md 写清 bucket 选择矩阵（业务线×接口类型→bucket），并给出一个可复制的示例（在 publicRequest/privateRequest 中 acquireSync）",
              "acceptance": "plan.md 有示例 + 明确的默认策略（例如无法识别时的保守选择）"
            }
          ]
        },
        {
          "name": "实现",
          "tasks": [
            {
              "description": "在 publicRequest/privateRequest 中插入 acquireSync(1)；必要时补齐/重命名 bucket 定义；确保每次请求都会走限流",
              "acceptance": "所有 public/private 请求在 fetch 前都会 acquireSync；业务线/接口类型正确路由；不捕获 token 不足异常"
            }
          ]
        },
        {
          "name": "验证与交接",
          "tasks": [
            {
              "description": "新增最小单测并运行 vendor-huobi 的 tsc/heft test；更新 context/SESSION_NOTES 写入可复现命令与后续 TODO",
              "acceptance": "测试通过；文档包含可复现命令；context.md 有快速交接"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2025-12-25T16:36:15.703Z",
      "status": "approved",
      "decidedAt": "2025-12-25T16:39:56.385Z",
      "decidedBy": "Claude",
      "createdTaskId": "huobi-publicprivate-api-tokenbucket"
    },
    {
      "id": "proposal-mjmi2ue8-8f5379",
      "name": "Hyperliquid API tokenBucket：按官方限额主动限流",
      "goal": "在 apps/vendor-hyperliquid 的 REST/WebSocket 请求入口前接入 tokenBucket 主动限流，并按 Hyperliquid 官方 rate limits & user limits 规则选择/扣减对应 bucket，避免触发 429/封禁。",
      "rationale": "仓库已在 Binance/Huobi 等 vendor 侧用 tokenBucket 做“请求前主动 acquire”的限流模式；Hyperliquid 官方文档对不同 API/动作给出了明确的速率与用户级限制。把这些限制落到 vendor-hyperliquid 的请求入口，并复用现有 tokenBucket/host 路由模式，可以让各 vendor 行为一致、减少线上 429 并便于观测。",
      "points": [
        "先调研并复用既有模式：参考 binance-private-api-host-tokenbucket 与 huobi-publicprivate-api-tokenbucket 的 bucket 定义方式、选择矩阵、以及在 request 前 acquire 的插入点",
        "限流策略以“保守”为默认：无法识别的 endpoint 走更严格 bucket；并为 429/headers 留出扩展位（可选）",
        "设计必须覆盖：bucket 列表（id/窗口/容量/维度 key）、endpoint→bucket 映射、错误/观测策略、以及实现落点（哪些文件/函数）",
        "先写 `.legion` 详细设计并等待 review，通过后再改代码",
        "保持实现简单直白；避免重复造轮子，优先复用仓库现成 tokenBucket/util"
      ],
      "scope": [
        "apps/vendor-hyperliquid/src/**",
        "apps/vendor-binance/src/**（仅对照阅读，不改）",
        "apps/vendor-huobi/src/**（仅对照阅读，不改）",
        ".legion/tasks/<new-task>/plan.md",
        ".legion/tasks/<new-task>/context.md",
        ".legion/tasks/<new-task>/tasks.md"
      ],
      "phases": [
        {
          "name": "调研",
          "tasks": [
            {
              "description": "阅读 binance-private-api-host-tokenbucket 与 huobi-publicprivate-api-tokenbucket 的实现/文档，总结“bucket 定义、维度 key、host/业务路由、acquire 插入点、观测与错误处理”模式，并记录到 context.md",
              "acceptance": "context.md 有清晰的对照笔记：关键文件/入口函数、bucket 选择矩阵、以及可直接复用的代码结构"
            }
          ]
        },
        {
          "name": "设计（先写文档，等待 review）",
          "tasks": [
            {
              "description": "根据 Hyperliquid 官方文档梳理 rate limits & user limits；产出详细设计：bucket 列表与参数、endpoint→bucket 映射、维度 key（IP/API key/address）、默认策略、以及未来扩展（429 回退/动态 headers）",
              "acceptance": "plan.md/context.md 写清：规则来源链接、bucket 表格、映射规则与示例；列出不确定点与待验证项；可直接据此进入实现"
            }
          ]
        },
        {
          "name": "实现",
          "tasks": [
            {
              "description": "在 vendor-hyperliquid 的 request 入口（REST/WS）调用 acquireSync/async acquire；按映射选择 bucket 并扣减；加最小日志/metadata（可复用 scopeError）",
              "acceptance": "所有对外请求在发起前都会先 acquire；不同 endpoint/动作走正确 bucket；无法识别时走保守 bucket"
            }
          ]
        },
        {
          "name": "验证与交接",
          "tasks": [
            {
              "description": "补最小单测/脚本验证映射与 key 隔离；运行 vendor-hyperliquid 的 tsc/测试；更新 context.md 快速交接",
              "acceptance": "验证命令可复现；测试通过；context.md 有下一步与排障指引"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2025-12-26T06:38:16.171Z",
      "status": "approved",
      "decidedAt": "2025-12-26T06:38:21.408Z",
      "decidedBy": "Claude",
      "createdTaskId": "hyperliquid-api-tokenbucket"
    },
    {
      "id": "proposal-mk0s97kq-82063b",
      "name": "OKX OHLC：publishChannel('ohlc') 梳理 + 写入 ohlc_v2 双写",
      "goal": "查找所有 publishChannel 发布 'ohlc' 的位置，并在 writeToSQL 时将 OHLC 数据同时写入 ohlc_v2 表（按表结构做映射）。",
      "rationale": "近期引入了 ohlc_v2 表，需要在现有 OHLC 写入链路上做无损迁移；先盘点所有 'ohlc' 发布点与现有 SQL 写入路径，再按 ohlc_v2 的字段结构补齐映射并开启双写，保证新旧表数据一致，便于后续切流与校验。",
      "points": [
        "先全仓搜索并列出所有 publishChannel('ohlc') 的发布点、payload 结构与来源（vendor/服务/调度器）",
        "定位 writeToSQL 调用链与旧表结构（ohlc/ohlc_interest_rate 等），确认哪些路径需要双写",
        "读取 ohlc_v2 表结构（迁移 SQL/类型定义），设计字段映射与主键/去重策略",
        "先写 .legion 详细设计并等待 review；通过后再落代码改动与最小验证"
      ],
      "scope": [
        "apps/vendor-okx/src/public-data/ohlc.ts",
        "**/*writeToSQL*",
        "**/*publishChannel*",
        "tools/sql-migration/**",
        "supabase/migrations/**",
        ".legion/tasks/<new-task>/{plan,context,tasks}.md"
      ],
      "phases": [
        {
          "name": "调研",
          "tasks": [
            {
              "description": "全仓搜索 publishChannel 发布 'ohlc' 的位置，记录每个发布点的来源、channel key、payload 字段、以及下游消费者/写入点。",
              "acceptance": "context.md 中有完整清单（文件路径+函数名+简要 payload schema），并标注哪些与 OKX 相关、哪些是公共链路。"
            },
            {
              "description": "定位 writeToSQL 的实现与调用路径：哪些地方把 OHLC 写入 SQL、写入哪张表、主键/唯一约束是什么。",
              "acceptance": "context.md 记录 writeToSQL 调用链与当前表结构/索引要点，并确认需要双写的插入点。"
            }
          ]
        },
        {
          "name": "设计（先写文档，等待 review）",
          "tasks": [
            {
              "description": "阅读 ohlc_v2 表结构（迁移 SQL/类型定义），设计从现有 OHLC payload → ohlc_v2 字段的映射、数据类型转换、以及冲突处理（upsert/ignore）。",
              "acceptance": "plan.md 写清字段映射表、冲突键、示例记录；列出待确认的不确定点；可直接据此进入实现。"
            }
          ]
        },
        {
          "name": "实现",
          "tasks": [
            {
              "description": "在 writeToSQL 写入 OHLC 的位置增加 ohlc_v2 的双写：保持原表不变，同时写入 ohlc_v2（必要时补齐 encodePath/decodePath 等工具）。",
              "acceptance": "所有 OHLC 写入都会同时落到旧表与 ohlc_v2；双写失败的错误处理符合现有模式；不会影响原链路。"
            }
          ]
        },
        {
          "name": "验证与交接",
          "tasks": [
            {
              "description": "补最小验证：单测/脚本对比同一批 OHLC 在两张表的字段值与数量；运行相关 package 的 tsc/测试；更新 context.md 快速交接。",
              "acceptance": "验证命令可复现；关键映射覆盖；context.md 有回滚开关与排障指引。"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2026-01-05T06:31:55.803Z",
      "status": "approved",
      "decidedAt": "2026-01-05T06:32:01.454Z",
      "decidedBy": "Claude",
      "createdTaskId": "okx-ohlcpublishchannelohlc-ohlc-v2"
    },
    {
      "id": "proposal-mk0uu4b6-6fb43a",
      "name": "全仓 Rush + PNPM + TS/Heft 工具链升级（2026-01）",
      "goal": "升级 RushJS/PNPM，并统一全仓 TypeScript/@types/node/Heft/API Extractor 到目标新版本，确保安装与构建通过。",
      "rationale": "当前仓库工具链版本跨度过大（Rush 5.147 + PNPM 6.7 + TS 4.7 + @types/node 22 等），会导致依赖生态/安全补丁/IDE 体验落后，且未来与 Node 版本演进不匹配。该任务用于在不做无关重构的前提下，把 Rush/PNPM/TS/Heft/api-extractor 统一升级到可用的最新组合，并通过分阶段验证降低风险。",
      "points": [
        "先输出详细设计（含目标版本、风险、回滚与验证步骤），人类 Review 通过后再改代码",
        "优先保持可读性与一致性：尽量批量机械替换版本号，避免无关重构",
        "优先用 Rush 的标准工作流（install-run-rush + rush update/install）驱动升级，避免手工 pnpm 直装造成偏差",
        "升级跨度很大（pnpm 6 -> 10, TS 4.x -> 5.9），拆成可回滚的阶段执行",
        "对 UI 包/特殊包（不使用 Heft 的）单独兜底处理，不强行套用同一套脚手架"
      ],
      "scope": [
        "rush.json",
        "common/config/rush/pnpm-lock.yaml",
        "common/config/rush/pnpm-config.json",
        "common/config/rush/common-versions.json",
        "common/scripts/*",
        "**/package.json",
        "**/tsconfig.json",
        "**/api-extractor.json",
        "**/config/*.json"
      ],
      "phases": [
        {
          "name": "调研与方案",
          "tasks": [
            {
              "description": "盘点当前 Rush/PNPM/TS/@types/node/Heft/API Extractor 版本与分布",
              "acceptance": "在 context.md 记录现状与变更范围（包含至少 1 个代表性包示例）"
            },
            {
              "description": "确定目标版本（Rush 最新、PNPM 为其支持的最新、TS 最新、@types/node 固定 24.x、Heft/rig/plugin 最新、api-extractor 最新）",
              "acceptance": "在 context.md 记录各工具目标版本号与选择理由（含备选方案）"
            },
            {
              "description": "输出升级执行步骤、验证清单、风险与回滚策略",
              "acceptance": "plan.md 包含可执行的分阶段步骤与明确的验收标准"
            }
          ]
        },
        {
          "name": "落地实施（待 Review 后执行）",
          "tasks": [
            {
              "description": "升级 Rush 版本与配套脚本/配置（如需要）",
              "acceptance": "`node common/scripts/install-run-rush.js -h` 显示新 Rush 版本；`rush install` 可运行"
            },
            {
              "description": "升级 PNPM 到新 Rush 支持的最新版本并重算 lockfile",
              "acceptance": "`rush update --full` 成功；`common/config/rush/pnpm-lock.yaml` 由新 pnpm 格式生成"
            },
            {
              "description": "批量升级各包 devDependencies：@types/node=24、typescript=最新、heft*、api-extractor",
              "acceptance": "全仓 `rg '\"@types/node\"'` 等关键依赖无旧版本残留；`rush install` 通过"
            },
            {
              "description": "修复因 TS/Heft 升级导致的构建/测试问题",
              "acceptance": "关键命令 `rush rebuild`（或仓库既定 build 命令）通过；必要时补充 globalOverrides/peerRules 并记录"
            },
            {
              "description": "格式化与收尾",
              "acceptance": "prettier 无格式噪音；context.md 写好交接与后续观察点"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2026-01-05T07:44:10.578Z",
      "status": "approved",
      "decidedAt": "2026-01-05T07:44:14.014Z",
      "decidedBy": "Claude",
      "createdTaskId": "rush-pnpm-tsheft-2026-01"
    },
    {
      "id": "proposal-mk3rcks9-273cc4",
      "name": "移除旧 ohlc 表引用并切换到 ohlc_v2",
      "goal": "全仓清理对旧 `ohlc` 表的读写/任务引用，统一改为 `ohlc_v2` 并对齐 series_id 编码与查询路径。",
      "rationale": "用户要求移除所有对旧表 `ohlc` 的引用并切换到 `ohlc_v2`；目前仓库仍存在多处写入/查询旧表的遗留点（vendor、kernel、UI、工具链）。需要集中盘点并统一迁移，避免新旧表并存导致数据不一致与调用混乱。",
      "points": [
        "盘点所有对 `ohlc` 表的写入/读取/任务引用并记录到 context 作为变更清单",
        "写入侧统一改为 `ohlc_v2`：createSeriesProvider、publishChannel 双写、QuerySeriesFromTimeBackward 写库路径等",
        "读取侧统一改为 `ohlc_v2`：kernel 单元与 Web UI SQL 查询/CollectSeries 参数",
        "series_id 统一改为 `encodeOHLCSeriesId`/`decodeOHLCSeriesId`，避免旧编码导致查询失配",
        "确认是否保留 `tools/sql-migration/sql/ohlc.sql` 与文档中的旧表说明，必要时加 review 条目"
      ],
      "scope": [
        "libraries/kernel/src/units/RealtimePeriodLoadingUnit.ts",
        "apps/vendor-binance/src/public-data/ohlc.ts",
        "apps/vendor-bitget/src/services/markets/ohlc.ts",
        "apps/vendor-okx/src/public-data/ohlc.ts",
        "apps/vendor-okx/src/utils/provideSeriesFromTimeBackwardService.ts",
        "apps/vendor-okx/src/utils/provideOHLCFromTimeBackwardService.ts",
        "apps/vendor-tq/src/index.ts",
        "apps/vendor-hyperliquid/src/services/markets/ohlc.ts",
        "ui/web/src/modules/Audit/Audit.tsx",
        "ui/web/src/modules/Audit/NetValueAudit.tsx",
        "ui/web/src/modules/Market/Market.tsx",
        "tools/sql-migration/sql/ohlc.sql（是否保留需确认）",
        "docs/zh-Hans/* 与 docs/en/*（若包含旧表引用需确认是否更新）"
      ],
      "phases": [
        {
          "name": "调研",
          "tasks": [
            {
              "description": "全仓确认旧表 `ohlc` 的实际引用点（写入/读取/任务参数），整理为文件清单与用途说明。",
              "acceptance": "context.md 有完整清单（路径 + 使用方式 + 关联调用链）"
            },
            {
              "description": "确认 `ohlc_v2` 表结构与 `series_id` 编码规则，评估 createSeriesProvider 的写入列/字段需要如何裁剪。",
              "acceptance": "context.md 记录字段映射与是否需要额外 helper/类型调整"
            }
          ]
        },
        {
          "name": "设计（待 review）",
          "tasks": [
            {
              "description": "给出逐文件替换策略：如何把旧表写入改为 `ohlc_v2`、如何处理双写/旧表兼容、以及 UI/Kernel 查询与 CollectSeries 参数的调整。",
              "acceptance": "plan.md 列出每个文件的改动要点与风险"
            },
            {
              "description": "列出需人类确认的问题（是否删除 `ohlc.sql`、是否更新文档、是否保留旧表数据迁移/回滚策略）。",
              "acceptance": "plan.md 或 context.md 中有 REVIEW 条目"
            }
          ]
        },
        {
          "name": "实现",
          "tasks": [
            {
              "description": "逐文件替换 `ohlc` -> `ohlc_v2`，并同步调整 `series_id` 编码/解码与写入列集合，移除旧表写入。",
              "acceptance": "所有旧表引用清零；写入/读取逻辑对齐新表"
            }
          ]
        },
        {
          "name": "验证与交接",
          "tasks": [
            {
              "description": "运行最小验证（按模块 tsc 或既有 build 命令）并更新 context 交接。",
              "acceptance": "context.md 记录验证命令与结果；说明回滚/兼容注意点"
            }
          ]
        }
      ],
      "proposedBy": "Claude",
      "proposedAt": "2026-01-07T08:29:51.801Z",
      "status": "approved",
      "decidedAt": "2026-01-07T08:31:34.455Z",
      "decidedBy": "Claude",
      "createdTaskId": "ohlc-ohlc-v2"
    }
  ]
}
