# RFC 对抗审查报告：node-unit 调度抢占策略与 deployment 类型

审查对象：`docs/rfc-node-unit-claim-policy.md`
审查结论：通过，无阻塞项。

## 必须修正（Blocking）

- 无。

## 逐条质疑与最小化建议

1. 是否必须新增 `NODE_UNIT_CLAIM_POLICY=none`

- 质疑点：是否可用现有策略或仅靠 `enabled=false` 达到“只运行本地已绑定部署”的目标？
- 结论：需要显式禁用抢占/分配的开关；RFC 已给出 R1/R13。
- 建议：保持 R1/R13 的“禁止任何写入 `deployment.address` 的路径”约束。
- 级别：可选优化（已满足，无需改动）。

2. `deployment.type` 是否最小化数据模型变更

- 质疑点：是否需要新增独立表或新实体来表达 `daemon`？
- 结论：复用 `deployment` 表加 `type` 字段是最小改动且易回滚。
- 建议：保持 `TEXT` + 默认值策略，不引入额外表或约束。
- 级别：可选优化（已满足，无需改动）。

3. `daemon` 的运行边界是否避免跨节点一致性假设

- 质疑点：要求“每个 node-unit 恰好一个实例”会引入全局协调。
- 结论：RFC 已改为“每个 node-unit 本地按 `enabled` 启停、以 `deployment.id` 去重”，避免跨节点一致性。
- 建议：保持本地幂等策略，不引入活跃列表或全局唯一性约束。
- 级别：可选优化（已满足，无需改动）。

4. 混部/回滚是否可控

- 质疑点：仅依赖流程会导致旧版本误抢占 `daemon`。
- 结论：RFC 已增加混部门禁与回滚约束，满足可回滚要求。
- 建议：保持“升级完成前 `daemon` 必须 `enabled=false`、回滚前禁用或转换”的硬性流程说明。
- 级别：可选优化（已满足，无需改动）。

5. 错误语义是否可实现与可验证

- 质疑点：`ERR_DAEMON_MISSING` 在无 `address` 时的检测来源？
- 结论：RFC 已限定为“本地执行器检测”，可实现、可验证。
- 建议：保持本地检测语义，不引入跨节点探测。
- 级别：可选优化（已满足，无需改动）。

6. 是否需要数据库层 `type` 约束

- 质疑点：无 DB 约束是否会引入脏数据？
- 结论：已有运行时白名单校验（R11），满足可实现/可验证；DB 约束为增强项。
- 建议：暂不新增约束；若后续出现脏数据再补充。
- 级别：可选优化。

## 可实现/可验证/可回滚检查

- 可实现：R1-R13 定义了明确的调度与执行器行为边界。
- 可验证：测试计划覆盖 `none` 模式、`daemon` 本地幂等与非法值处理。
- 可回滚：升级/回滚门禁已明确，满足回滚条件。
