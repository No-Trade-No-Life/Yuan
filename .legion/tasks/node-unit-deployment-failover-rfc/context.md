# node-unit-deployment-failover-rfc - ä¸Šä¸‹æ–‡

## ä¼šè¯è¿›å±• (2026-01-14)

### âœ… å·²å®Œæˆ

- æ¢³ç† node-unit éƒ¨ç½²ç»‘å®šï¼šnode-unit ä»…æ‹‰å– `deployment` è¡¨ä¸­ `enabled=true` ä¸” `address=nodeUnit public key` çš„è®°å½•ï¼Œé€šè¿‡ `listWatch` é©±åŠ¨ `runDeployment` ç”Ÿå‘½å‘¨æœŸã€‚
- æ¢³ç† deployment æ¨¡å‹ä¸è¡¨ç»“æ„ï¼š`IDeployment.address` ä¸ºç©ºè¡¨ç¤ºæœªæŒ‡å®šèŠ‚ç‚¹ï¼›SQL schema é»˜è®¤å€¼ä¸ºç©ºå­—ç¬¦ä¸²ã€‚
- ç¡®è®¤ host å‘å¸ƒ terminal join/exitï¼š`apps/host/src/host-manager.ts` é€šè¿‡ `HostEvent` channel å¹¿æ’­ `TERMINAL_CHANGE`ï¼Œè¿æ¥å…³é—­æˆ– ping å¤±è´¥ä¼šå‘é€ `payload.old`ï¼ŒUpdateTerminalInfo ä¼šå‘é€ `payload.new` æˆ– updateã€‚
- ç¡®è®¤ terminal ä¾§ join/exit å¤„ç†ï¼š`libraries/protocol/src/terminal.ts` è®¢é˜… `HostEvent`ï¼Œå°† `TERMINAL_CHANGE` æ˜ å°„ä¸º JOIN/LEAVE/UPDATE å¹¶æ›´æ–° `terminalInfos# node-unit-deployment-failover-rfc - ä¸Šä¸‹æ–‡

## ä¼šè¯è¿›å±• (2026-01-14)

ã€‚

- å½“å‰ä»“åº“æœªå‘ç°â€œæœªè°ƒåº¦ deploymentâ€å‘ç°/æŠ¢å é€»è¾‘ï¼›éœ€è¦æ–°è®¾è®¡å¡«è¡¥ï¼ˆå¯èƒ½æ”¾åœ¨ node-unit æˆ–ç‹¬ç«‹è°ƒåº¦å™¨ï¼‰ã€‚
- å·²å®Œæˆ RFC è®¾è®¡å¹¶æ›´æ–° plan.mdï¼šè¦†ç›–å¤±è”æ£€æµ‹ã€address ç½®ç©ºã€æŠ¢å è§„åˆ™ã€æœ€å°‘éƒ¨ç½²ä¼˜å…ˆã€æŒ‡æ ‡æ¥å£æŠ½è±¡ã€å¹¶å‘ç­–ç•¥ä¸å€™é€‰æ’åºã€‚
- å·²è½åœ° node-unit è°ƒåº¦å¾ªç¯ï¼šå¤±è”åœ°å€é‡Šæ”¾ã€æœ€å°‘éƒ¨ç½²æŠ¢å ã€ä¸€æ¬¡ä»…æŠ¢å ä¸€ä¸ªã€‚
- å·²è¿è¡Œ `pnpm -C apps/node-unit build`ï¼ˆheft test + api-extractor + post-buildï¼‰é€šè¿‡ï¼›ä»…æç¤º TypeScript 5.9.3 ç‰ˆæœ¬å‘Šè­¦ã€‚
- è°ƒåº¦é—´éš”æ”¯æŒé€šè¿‡ `NODE_UNIT_SCHEDULER_INTERVAL_MS` è¦†ç›–ã€‚
- å·²è¿è¡Œ `rush build --to @yuants/node-unit` æˆåŠŸï¼ˆè­¦å‘Šï¼šNode.js 24.11.0 æœªè¢« Rush æµ‹è¯•ï¼‰ã€‚
- å·²å®Œæˆæœ¬åœ° E2Eï¼šTimescaleDB + host + postgres-storage + ä¸¤ä¸ª node-unitï¼›æ’å…¥ deployments åï¼Œåœæ‰ node-unit-2ï¼Œaddress æ¸…ç©ºåç”± node-unit-1 æ¯è½®æŠ¢å ä¸€ä¸ªå¹¶æœ€ç»ˆæ¥ç®¡ã€‚
- å·²æŒ‰â€œéš”ç¦»ç¯å¢ƒå˜é‡â€é‡æ–°æ‰§è¡Œ E2Eï¼ˆ`env -i`ï¼‰ï¼Œç¡®è®¤ä¸ä¼šç»§æ‰¿ shell.nixï¼›æŠ¢å è¡Œä¸ºç¬¦åˆé¢„æœŸã€‚
- å·²æŒ‰ portal 5 å®ä¾‹é‡æ–°è·‘ E2Eï¼ˆéš”ç¦»ç¯å¢ƒå˜é‡ï¼‰ï¼šæœ€ç»ˆåˆ†é…ä¸º node-unit-1=2ã€node-unit-2=3ï¼ŒæœªæŠ¢å åœ¨çº¿èŠ‚ç‚¹ã€‚
- å·²å®ç° v2 èµ„æºè°ƒåº¦ï¼šnode-unit ä¸ŠæŠ¥ CPU/å†…å­˜åˆ° terminalInfo.tagsï¼Œscheduler æ”¯æŒ `resource_usage` policy ä¸æƒé‡/é—´éš”é…ç½®ã€‚
- å·²ç”¨ `NODE_UNIT_CLAIM_POLICY=resource_usage` é‡æ–°è·‘ E2Eï¼ˆéš”ç¦»ç¯å¢ƒå˜é‡ï¼‰ï¼Œç”Ÿæˆä¸­æ–‡æŠ¥å‘Š `reports/node-unit-portal-resource-usage-e2e-report.md`ã€‚
- è¡¥å……æŠ¢å æ—¶èµ„æºå¿«ç…§æ—¥å¿—å¹¶åœ¨æŠ¥å‘Šä¸­æŒ‰è½®æ¬¡è®°å½• CPU/å†…å­˜ä½¿ç”¨æƒ…å†µï¼›é‡æ–°è·‘èµ„æºç­–ç•¥ E2Eã€‚
- æŒ‰æœ€æ–°è®¾è®¡èšåˆ node-unit ä¸»è¿›ç¨‹+å­è¿›ç¨‹èµ„æºä¸ŠæŠ¥ï¼Œé‡æ–°è·‘ resource_usage E2Eï¼Œå¹¶æ›´æ–°ä¸­æ–‡æŠ¥å‘Šä¸èµ„æºå¿«ç…§è¡¨ã€‚
- æŒ‰ 21 ä¸ª portal é‡æ–°è·‘èµ„æºç­–ç•¥ E2Eï¼Œæ›´æ–°æŠ¥å‘Šå¹¶è®°å½•æ¯è½®æŠ¢å èµ„æºå¿«ç…§ã€‚
- å®ç° scheduler å•å…ƒæµ‹è¯•ï¼Œä¿®å¤ TypeScript ç±»å‹é”™è¯¯ï¼Œmock å¤–éƒ¨ä¾èµ–ï¼Œæ‰€æœ‰æµ‹è¯•é€šè¿‡
- å®Œæˆæ„å»ºéªŒè¯ï¼Œæµ‹è¯•é€šè¿‡ï¼Œæ— ç¼–è¯‘é”™è¯¯
- æ›´æ–° tasks.md å’Œ context.md åæ˜ ä»»åŠ¡å®Œæˆ
- å·²å¢åŠ  eligibility/candidate/claim åŸå› æ—¥å¿—å¹¶é‡æ–°è·‘ 21 portal E2Eï¼Œç”Ÿæˆæ›´æ–°åçš„ä¸­æ–‡æŠ¥å‘Šã€‚
- [Refactor] apps/node-unit/src/index.ts: ç§»é™¤ tags æ›´æ–°é€»è¾‘ï¼Œæ³¨å†Œ NodeUnit/InspectResourceUsage æœåŠ¡
- [Refactor] apps/node-unit/src/scheduler.ts: å®ç° fetchResourceUsageï¼Œä½¿ç”¨ terminal.client.request æ›¿ä»£ loadResourceUsage ä» tags è¯»å–
- [Test] apps/node-unit/src/scheduler.test.ts: æ›´æ–°å•å…ƒæµ‹è¯•ï¼ŒMock è¿œç¨‹ Service è°ƒç”¨ï¼ŒéªŒè¯å¼‚å¸¸å¤„ç†ä¸è¶…æ—¶é€»è¾‘
- [Build] pnpm build é€šè¿‡ï¼ŒTypeScript 5.9.3 å…¼å®¹æ€§æ£€æŸ¥é€šè¿‡

### ğŸŸ¡ è¿›è¡Œä¸­

(æš‚æ— )

### âš ï¸ é˜»å¡/å¾…å®š

(æš‚æ— )

---

## å…³é”®æ–‡ä»¶

| æ–‡ä»¶                                                    | ç”¨é€”                                              | çŠ¶æ€   |
| ------------------------------------------------------- | ------------------------------------------------- | ------ |
| `apps/node-unit/src/scheduler.ts`                       | è°ƒåº¦å™¨æ ¸å¿ƒå®ç°ï¼ˆå¤±è”æ£€æµ‹ã€æŠ¢å é€»è¾‘ã€ç­–ç•¥æ¥å£ï¼‰    | å·²å®Œæˆ |
| `apps/node-unit/src/scheduler.test.ts`                  | å•å…ƒæµ‹è¯•ï¼ˆå®Œæˆï¼Œ29 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼‰               | å·²å®Œæˆ |
| `apps/node-unit/src/logging.test.ts`                    | å‚è€ƒï¼šç°æœ‰ Jest æµ‹è¯•æ¨¡å¼                          | å·²å®Œæˆ |
| `reports/node-unit-portal-resource-usage-e2e-report.md` | E2E æµ‹è¯•æŠ¥å‘Šï¼ˆ21 portal Ã— resource_usage policyï¼‰ | å·²å®Œæˆ |

---

## å…³é”®å†³ç­–

| å†³ç­–                                                                                                                                          | åŸå›                                                                      | æ›¿ä»£æ–¹æ¡ˆ                                                                              | æ—¥æœŸ       |
| --------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------ | ------------------------------------------------------------------------------------- | ---------- |
| ç¡®è®¤å¤±è”/æŠ¢å ç­–ç•¥ï¼šå¤±è”ä»…ä¾èµ– terminalInfos$ ç¼ºå¤±ï¼›æŠ¢å æ’åº updated_at/created_at/id å‡åºï¼›æŠ¢å èµ„æ ¼ä»…ç»Ÿè®¡å·²æŒ‡æ´¾ deploymentï¼›è°ƒåº¦é—´éš”é»˜è®¤ 5sã€‚ | ç”¨æˆ· review æ˜ç¡®ç¡®è®¤ï¼Œä¸å¼•å…¥ç¼“å†²æ—¶é—´æˆ–é¢å¤–æƒé‡æŒ‡æ ‡ï¼Œä¿æŒç­–ç•¥ç®€å•å¯é¢„æµ‹ã€‚ | å¢åŠ ç¦»çº¿ç¼“å†²æ—¶é—´ã€å¼•å…¥ address='' è®¡å…¥è´Ÿè½½æˆ–æ”¹ç”¨è‡ªå®šä¹‰ä¼˜å…ˆçº§æ ‡ç­¾ã€ç¼©çŸ­/æ‹‰é•¿è°ƒåº¦é—´éš”ã€‚ | 2026-01-14 |

---

## å¿«é€Ÿäº¤æ¥

**ä»»åŠ¡å·²å®Œæˆ** âœ…

æœ¬ä»»åŠ¡çš„æ‰€æœ‰ç›®æ ‡å‡å·²å®ç°ï¼š

1. âœ… **RFC è®¾è®¡ä¸å®ç°**ï¼šå¤±è”æ£€æµ‹ã€address ç½®ç©ºã€æŠ¢å è§„åˆ™ã€æœ€å°‘éƒ¨ç½²ä¼˜å…ˆã€èµ„æºè°ƒåº¦ç­–ç•¥
2. âœ… **æ ¸å¿ƒåŠŸèƒ½**ï¼šnode-unit è°ƒåº¦å™¨ï¼Œæ”¯æŒ `deployment_count` å’Œ `resource_usage` ä¸¤ç§ç­–ç•¥
3. âœ… **èµ„æºä¸ŠæŠ¥**ï¼šnode-unit ä¸ŠæŠ¥èšåˆ CPU/å†…å­˜ä½¿ç”¨ç‡ï¼ˆä¸»è¿›ç¨‹+æ‰€æœ‰å­è¿›ç¨‹ï¼‰
4. âœ… **ç«¯åˆ°ç«¯æµ‹è¯•**ï¼šå¤šä¸ªåœºæ™¯éªŒè¯ï¼Œç”Ÿæˆä¸­æ–‡æŠ¥å‘Š
5. âœ… **å•å…ƒæµ‹è¯•**ï¼šscheduler å•å…ƒæµ‹è¯•å®Œæˆï¼Œ29 ä¸ªæµ‹è¯•å…¨éƒ¨é€šè¿‡
6. âœ… **æ„å»ºéªŒè¯**ï¼šTypeScript ç¼–è¯‘é€šè¿‡ï¼Œæ— é”™è¯¯

**åç»­å»ºè®®ï¼š**

- å¦‚éœ€é•¿æœŸéªŒè¯ï¼Œå¯åœ¨çœŸå®é›†ç¾¤å¤ç°åŒæ ·æµç¨‹è§‚å¯Ÿå¹¶å‘æŠ¢å 
- å¯è€ƒè™‘æ·»åŠ æ›´å¤šè°ƒåº¦ç­–ç•¥æˆ–æ‰©å±•èµ„æºæŒ‡æ ‡
- ç›‘æ§ç”Ÿäº§ç¯å¢ƒä¸­çš„è°ƒåº¦è¡Œä¸ºï¼Œç¡®ä¿ç¨³å®šè¿è¡Œ

---

_æœ€åæ›´æ–°: 2026-01-15 15:16 by Claude_
