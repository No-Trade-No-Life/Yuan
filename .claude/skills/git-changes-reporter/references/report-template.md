# Git 变更报告模板

此模板用于指导 Agent 生成语义化 Markdown 报告。报告应基于 `generate-json.js` 生成的 JSON 数据，并结合实际代码分析。

## 报告结构

````markdown
# Git 变更报告（<range.label>）

## 1. 概览

- **时间范围**：<range.startDate> 至 <range.endDate>
- **提交数量**：<range.commitCount> 个提交
- **主要贡献者**：<前 3 位 contributors>
- **热点目录**：<前 3 个 topDirs>
- **生成时间**：<range.generatedAt>

## 2. 改动聚焦领域

### 2.1 <领域名称：如错误处理与观测>

- **涉及目录**：<相关目录列表>
- **关键提交**：
  - `<commit.short>`：`<commit.subject>`
  - `<commit.short>`：`<commit.subject>`
- **核心改动**：
  - `<file.path>`：<具体改动描述，从 patch 或代码分析得出>
  - `<file.path>`：<具体改动描述>
- **设计意图**：<从提交信息和代码变更推断的意图>

### 2.2 <领域名称：如安全与鉴权>

...

## 3. 贡献者分析

| 作者               | 提交数                | 主要贡献领域 | 关键提交         |
| ------------------ | --------------------- | ------------ | ---------------- |
| <contributor.name> | <contributor.commits> | <领域>       | `<commit.short>` |
| <contributor.name> | <contributor.commits> | <领域>       | `<commit.short>` |

## 4. 技术影响与风险

### 兼容性影响

- <描述兼容性变更，如 API 变更、配置格式变化>

### 配置变更

- <新增、修改或删除的配置项>

### 性能影响

- <可能影响性能的变更>

### 测试覆盖

- <新增或修改的测试文件>
- <测试策略变化>

## 5. 单提交摘要（附录）

### <commit.short> <commit.author> | <commit.authoredAt> | <标签>

**主题**：`<commit.subject>`

**变更要点**：

- **文件/目录**：`<file.path>` - <改动描述与目的>
- **接口/协议**：<接口变更描述>
- **行为/数据流**：<运行时行为变化>
- **观测/指标**：<新增或变更的监控>

**风险/影响**：

- <兼容性影响>
- <配置要求>
- <依赖变更>

**测试**：

- <测试文件路径> 或 "未见测试记录"

---

## 语义聚类指南

### 领域分类标准

#### 错误处理与观测

- 异常处理逻辑变更
- 日志格式或级别调整
- 监控指标新增/修改
- 告警规则变更
- 健康检查改进

#### 安全与鉴权

- 认证机制变更
- 授权逻辑调整
- 加密算法更新
- 输入验证增强
- 安全头设置

#### 功能开发

- 新特性实现
- API 端点新增/修改
- 业务逻辑变更
- 用户界面改进
- 数据模型扩展

#### 重构与优化

- 代码结构重组
- 性能优化
- 内存使用改进
- 代码清理
- 依赖解耦

#### 运维与部署

- 配置管理变更
- 部署脚本更新
- CI/CD 流水线调整
- 文档更新
- 环境变量管理

#### 依赖更新

- 包版本升级
- 第三方库替换
- 依赖关系调整
- 构建工具变更

### 分析深度建议

#### Level 1：基础分析（快速概览）

- 仅基于 JSON 数据
- 统计信息汇总
- 目录热度分析
- 贡献者统计

#### Level 2：中级分析（团队同步）

- 查看关键提交的 patch
- 识别主要技术领域
- 评估风险等级
- 提供改进建议

#### Level 3：深度分析（代码审查）

- 查看实际代码文件
- 分析变更上下文
- 评估架构影响
- 提供详细建议

## 写作风格指南

### 文件引用格式

- 完整路径：`apps/vendor-aster/src/quote.ts`
- 带行号：`libraries/protocol/src/terminal.ts:138-143`
- IDE 链接格式：`[terminal.ts:138-143](libraries/protocol/src/terminal.ts#L138-L143)`

### 提交引用格式

- 短哈希：`03a48cfc4`
- 带主题：`03a48cfc4 (feat: enforce terminal_id...)`
- 带链接：`[03a48cfc4](https://github.com/owner/repo/commit/03a48cfc4)`
- 上下文引用：`在 03a48cfc4 中，CZ 改进了...`

**⚠️ 重要警告**：

- **绝对不要使用 JSON 文件的行号作为 commit ID**（例如：`1279`、`703` 等）
- JSON 文件中的行号（如 `1279`）只是文件位置，不是 commit 标识符
- 正确的 commit ID 在 JSON 的 `"short"` 字段中（如 `"a9300e76f"`）
- 错误示例：`1279`（行号） ❌
- 正确示例：`a9300e76f`（短哈希） ✅

### 语气与表达

- **客观专业**：基于事实，避免主观判断
- **简明扼要**：使用短句和列表，避免冗长段落
- **聚焦意图**：解释"为什么"而不仅是"做了什么"
- ** actionable**：提供具体建议而非泛泛而谈

### 风险描述

- **高风险**：可能导致系统故障、数据丢失、安全漏洞
- **中风险**：可能影响功能、性能或用户体验
- **低风险**：轻微影响，易于修复

## 质量检查清单

生成报告后检查：

- [ ] 提交范围正确无误
- [ ] 每个技术领域有具体文件引用
- [ ] 贡献者分析完整准确
- [ ] 风险识别全面
- [ ] 建议具体可行
- [ ] 格式规范统一
- [ ] 链接可点击（在 IDE 环境中）
- [ ] 无拼写或语法错误
- [ ] **commit 引用使用正确的短哈希，而不是 JSON 行号**

## 示例报告片段

### 概览示例

```markdown
## 1. 概览

- **时间范围**：2025-11-26 至 2025-12-02
- **提交数量**：32 个提交
- **主要贡献者**：CZ (16), humblelittlec1[bot] (11), Ryan (2)
- **热点目录**：apps (239 files), libraries (71 files), common (68 files)
- **生成时间**：2025-12-02T06:23:53.974Z
```
````

### 领域分析示例

```markdown
### 2.1 错误处理与观测

- **涉及目录**：`libraries/protocol/`, `apps/vendor-aster/`
- **关键提交**：
  - `03a48cfc4`：`feat: enforce terminal_id to be derived from public_key`
  - `1b4e97ac5`：`fix: improve error handling in quote service`
- **核心改动**：
  - `libraries/protocol/src/terminal.ts:138-143`：连接 URL 中强制用公钥派生 `terminal_id`，保证 ID 与密钥绑定
  - `apps/vendor-aster/src/quote.ts:45-60`：增强报价服务错误处理，添加重试逻辑和详细日志
- **设计意图**：提高系统安全性和可观测性，确保终端身份可验证，改进故障排查能力
```

### 单提交摘要示例

```markdown
### 03a48cfc4 CZ | 2025-11-22T01:07:13+08:00 | 安全

**主题**：`feat: enforce terminal_id to be derived from public_key in Terminal...`

**变更要点**：

- **文件/目录**：`libraries/protocol/src/terminal.ts:138` - 连接 URL 中强制用公钥派生 `terminal_id`，保证 ID 与密钥绑定
- **接口/协议**：`terminal.ts:140-143` - 对 `host_token` 进行签名并随连接参数发送，用于身份校验
- **行为/数据流**：终端连接时自动计算并验证身份，无需手动配置 ID
- **观测/指标**：新增连接身份验证成功/失败指标

**风险/影响**：

- 依赖自定义 `terminal_id` 的客户端需改为公钥派生，否则连接可能被拒
- 需要更新相关文档和客户端示例

**测试**：未见测试记录
```
