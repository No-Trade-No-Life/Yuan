#!/usr/bin/env node
/* eslint-disable no-console */
const { readFile, writeFile } = require('node:fs/promises');
const { URL } = require('node:url');

const usage = () => {
  console.error(
    [
      'Usage: generate-github-links.js <json_file> <repo_url> [output_file]',
      '',
      'Add GitHub commit links to JSON data generated by generate-json.js',
      '',
      'Arguments:',
      '  <json_file>    Path to JSON file generated by generate-json.js',
      '  <repo_url>     GitHub repository URL (e.g., https://github.com/owner/repo)',
      '  [output_file]  Optional output file (default: <json_file>.with-links.json)',
      '',
      'Examples:',
      '  generate-github-links.js ./reports/changes.json https://github.com/owner/repo',
      '  generate-github-links.js changes.json https://github.com/owner/repo ./changes-with-links.json',
    ].join('\n'),
  );
};

const validateGitHubUrl = (url) => {
  try {
    const parsed = new URL(url);
    return parsed.hostname === 'github.com' && parsed.pathname.split('/').filter(Boolean).length >= 2;
  } catch {
    return false;
  }
};

const extractRepoPath = (url) => {
  try {
    const parsed = new URL(url);
    const pathParts = parsed.pathname.split('/').filter(Boolean);
    if (pathParts.length < 2) {
      throw new Error('Invalid GitHub repository URL');
    }
    return `${pathParts[0]}/${pathParts[1]}`;
  } catch (error) {
    throw new Error(`Failed to parse repository URL: ${error.message}`);
  }
};

const addGitHubLinks = (data, repoPath) => {
  const baseUrl = `https://github.com/${repoPath}/commit`;

  // Add githubUrl to each commit
  const commitsWithLinks = data.commits.map((commit) => ({
    ...commit,
    githubUrl: `${baseUrl}/${commit.hash}`,
  }));

  // Add repository info to metadata
  const metadata = {
    ...data.metadata,
    github: {
      repository: repoPath,
      baseUrl: `https://github.com/${repoPath}`,
      commitUrlTemplate: `${baseUrl}/{hash}`,
    },
  };

  return {
    ...data,
    commits: commitsWithLinks,
    metadata,
  };
};

const main = async () => {
  const [jsonFile, repoUrl, outputFile] = process.argv.slice(2);

  // Validate arguments
  if (!jsonFile || !repoUrl) {
    usage();
    process.exit(1);
  }

  // Validate GitHub URL
  if (!validateGitHubUrl(repoUrl)) {
    console.error('Error: Invalid GitHub repository URL');
    console.error('Expected format: https://github.com/owner/repo');
    process.exit(1);
  }

  // Extract repository path
  let repoPath;
  try {
    repoPath = extractRepoPath(repoUrl);
    console.info(`Repository: ${repoPath}`);
  } catch (error) {
    console.error(`Error: ${error.message}`);
    process.exit(1);
  }

  // Determine output file
  const output = outputFile || jsonFile.replace(/\.json$/, '.with-links.json');

  try {
    // Read JSON file
    console.info(`Reading JSON file: ${jsonFile}`);
    const fileContent = await readFile(jsonFile, 'utf-8');
    const data = JSON.parse(fileContent);

    // Validate JSON structure
    if (!data.commits || !Array.isArray(data.commits)) {
      throw new Error('Invalid JSON structure: missing or invalid "commits" array');
    }

    // Add GitHub links
    console.info('Adding GitHub commit links...');
    const dataWithLinks = addGitHubLinks(data, repoPath);

    // Write output
    await writeFile(output, JSON.stringify(dataWithLinks, null, 2));
    console.info(`‚úÖ GitHub links added to ${output}`);
    console.info(`üìä Added ${dataWithLinks.commits.length} commit links`);

    // Show example links
    if (dataWithLinks.commits.length > 0) {
      const firstCommit = dataWithLinks.commits[0];
      const lastCommit = dataWithLinks.commits[dataWithLinks.commits.length - 1];
      console.info('\nExample commit links:');
      console.info(`  First: ${firstCommit.short} -> ${firstCommit.githubUrl}`);
      console.info(`  Last:  ${lastCommit.short} -> ${lastCommit.githubUrl}`);
    }
  } catch (error) {
    console.error('‚ùå Error:', error?.stack || error?.message || error);
    process.exit(1);
  }
};

main().catch((err) => {
  console.error('‚ùå Unexpected error:', err?.stack || err?.message || err);
  process.exit(1);
});
